# Implementation Plan

## Task 1: スキーマ変更 - eventSeriesIdのnullable化

- [ ] 1. eventsテーブルのeventSeriesIdをオプショナルに変更する
  - eventsテーブルのeventSeriesId列からnotNull制約を削除する
  - バリデーションスキーマをオプショナルフィールドとして更新する
  - マイグレーションを生成して実行する
  - 既存のイベントデータが正常に動作することを確認する
  - _Requirements: 9.1, 9.2, 9.3_

## Task 2: CSVパーサー

- [ ] 2. レガシーCSV専用パーサーを実装する
- [ ] 2.1 (P) 基本的なCSVパース機能を実装する
  - CSVファイルをパースしてレコード配列に変換する機能を実装する
  - 重複ヘッダー行（データ途中に出現するヘッダー）を自動的にスキップする
  - 必須カラム（circle, album, title等）の存在を検証する
  - パースエラー時は行番号と具体的なエラー内容を返却する
  - _Requirements: 1.1, 1.2, 1.5, 1.6_

- [ ] 2.2 (P) 複数値パース機能を実装する
  - artists列とoriginal_songs列のコロン区切り複数値を個別のエンティティに分割する
  - circle列の「×」区切り複合サークル名を個別のサークルに分割する
  - 分割後の各値から前後の空白を除去する
  - _Requirements: 1.3, 1.4_

## Task 3: 原曲マッチング

- [ ] 3. 原曲名と公式楽曲データベースのマッチング機能を実装する
- [ ] 3.1 (P) 完全一致マッチングを実装する
  - 原曲名を公式楽曲データベースと完全一致で検索する
  - 一致した場合は自動的にマッピングを確定する
  - マッチ結果のデータ構造（候補リスト、マッチタイプ、選択状態）を定義する
  - _Requirements: 2.1_

- [ ] 3.2 部分一致マッチングを実装する
  - 完全一致が見つからない場合に部分一致（前方/後方/部分）で検索する
  - 候補リストを生成してユーザー選択用に返却する
  - 検索結果の件数を制限してパフォーマンスを確保する
  - _Requirements: 2.2, 2.4_

- [ ] 3.3 「オリジナル」の特殊処理を実装する
  - 原曲名が「オリジナル」の場合は既存のオリジナルレコードに自動紐付けする
  - 空文字列の原曲名はスキップする
  - _Requirements: 2.3_

## Task 4: インポートサービス

- [ ] 4. データベースへの一括登録サービスを実装する
- [ ] 4.1 イベント・サークル・アーティスト登録を実装する
  - 新規イベントをeventsテーブルに登録する機能を実装する
  - イベント名からeventSeriesをパターンマッチで検索し、見つからない場合はnullを設定する
  - 新規サークル・既存サークルの判定とcirclesテーブルへの登録を実装する
  - 複合サークル（「×」区切り）の各サークルを個別に登録する
  - 新規アーティストをartistsテーブルに登録し、頭文字を自動判定する
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7_

- [ ] 4.2 リリース・トラック登録を実装する
  - 新規アルバムをreleasesテーブルに登録する機能を実装する
  - 複合サークルのreleaseCircles複数紐付けを実装する（position順）
  - 新規トラックをtracksテーブルに登録する機能を実装する
  - CSVのtrack_number列の値をtrackNumber列に設定する
  - 同一リリース・同一trackNumberの既存トラックは更新する（upsert）
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ] 4.3 クレジット・原曲紐付け登録を実装する
  - vocalists列のアーティストをvocalistロールでtrackCredits/trackCreditRolesに登録する
  - arrangers列のアーティストをarrangerロールでtrackCredits/trackCreditRolesに登録する
  - lyricists列のアーティストをlyricistロールでtrackCredits/trackCreditRolesに登録する
  - マッピング済み原曲をtrackOfficialSongsテーブルに紐付け登録する
  - 1トラックに複数の原曲がある場合はすべての紐付けを作成する
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 4.4 トランザクション管理を実装する
  - 依存関係順（events → circles → artists → releases → tracks → credits）でデータを登録する
  - 同一インポートセッション内の処理をトランザクションで管理する
  - 致命的なエラー発生時はロールバックして部分的なデータ登録を防ぐ
  - 非致命的なエラーの行はスキップし、他の行は正常に処理を続行する
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 6.4_

## Task 5: APIエンドポイント

- [ ] 5. インポートAPIエンドポイントを実装する
- [ ] 5.1 プレビューエンドポイントを実装する
  - POST /api/admin/import/legacy/preview エンドポイントを作成する
  - マルチパートフォームデータでCSVファイルを受け付ける
  - ファイルサイズ制限を設定してバリデーションする
  - CSVパース結果と原曲マッチング候補を返却する
  - Zodスキーマでリクエスト/レスポンスをバリデーションする
  - _Requirements: 1.1, 1.5, 2.1, 2.2_

- [ ] 5.2 実行エンドポイントを実装する
  - POST /api/admin/import/legacy/execute エンドポイントを作成する
  - パースされたレコードと原曲マッピングを受け取る
  - インポートサービスを呼び出してデータ登録を実行する
  - 各エンティティの作成件数・更新件数・エラー情報を返却する
  - 管理者認証ミドルウェアを適用する
  - _Requirements: 3.1, 4.1, 5.1, 6.1, 6.2_

## Task 6: UIコンポーネント

- [ ] 6. インポートウィザードUIを実装する
- [ ] 6.1 (P) CSVアップロードステップを実装する
  - CSVファイルを選択・アップロードするUIを実装する
  - アップロード後にプレビューテーブルを表示する
  - パースエラーがある場合は行番号と具体的なエラー内容を表示する
  - CSV形式でないファイルの場合はエラーメッセージを表示して拒否する
  - _Requirements: 1.1, 1.5, 1.6_

- [ ] 6.2 原曲マッピングステップを実装する
  - 原曲マッピングの確認・修正UIを実装する
  - 完全一致の原曲は自動マッピング確定状態で表示する
  - 部分一致の原曲は候補リストから選択可能にする
  - マッチしない原曲は手動選択またはスキップを可能にする
  - 未マッピング数とマッピング済み数を表示する
  - マッピング結果を保持して次のステップに引き継ぐ
  - _Requirements: 2.1, 2.2, 2.4, 2.5, 2.6_

- [ ] 6.3 インポート結果ステップを実装する
  - インポート処理の結果サマリー（総レコード数、成功数、エラー数）を表示する
  - 各エンティティの作成件数と更新件数を表示する
  - エラーが発生したレコードの詳細を表示する
  - 関連する管理画面へのリンクを提供する
  - _Requirements: 6.1, 6.2, 6.3, 6.5_

- [ ] 6.4 ウィザードコンテナを実装する
  - 3ステップウィザード（アップロード → 原曲マッピング → 結果）を管理するコンテナを実装する
  - ステップ間のデータ保持をReact useStateで管理する
  - 各ステップで「戻る」「次へ」ボタンを提供する
  - インポート処理中はローディング状態を表示してユーザー操作を制限する
  - 管理画面デザインガイドラインに準拠したUIを提供する
  - _Requirements: 8.2, 8.3, 8.4, 8.5_

## Task 7: ナビゲーション統合

- [ ] 7. サイドバーナビゲーションにインポート機能を追加する
  - 管理画面サイドバーに「インポート」セクションを追加する
  - レガシーCSVインポートページへのリンクを配置する
  - adminルーターにインポートルートを追加する
  - _Requirements: 8.1_

## Task 8: テスト

- [ ] 8. テストを実装する
- [ ] 8.1 (P) パーサーとマッチャーのユニットテストを実装する
  - LegacyCSVParser: 正常CSV、重複ヘッダー、コロン区切り、×区切りのテスト
  - SongMatcher: 完全一致、部分一致、オリジナル、マッチなしのテスト
  - splitCircles: 「×」区切り分割ロジックのテスト
  - parseEventName: イベント名パースロジックのテスト
  - _Requirements: 1.2, 1.3, 1.4, 2.1, 2.2, 2.3_

- [ ] 8.2 APIエンドポイントの統合テストを実装する
  - /api/admin/import/legacy/preview: ファイルアップロード→パース→マッチングのテスト
  - /api/admin/import/legacy/execute: 全テーブルへのupsertのテスト
  - トランザクションロールバック: 途中エラー時の整合性テスト
  - _Requirements: 7.2, 7.3_

- [ ]*8.3 ウィザードフローのE2Eテストを実装する
  - 3ステップウィザードの完走テスト
  - 原曲マッピングの手動選択テスト
  - エラー表示と再試行テスト
  - _Requirements: 8.2, 8.3, 8.4_

---

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1 | 2.1, 5.1, 6.1 |
| 1.2 | 2.1, 8.1 |
| 1.3 | 2.2, 8.1 |
| 1.4 | 2.2, 8.1 |
| 1.5 | 2.1, 5.1, 6.1 |
| 1.6 | 2.1, 6.1 |
| 2.1 | 3.1, 5.1, 6.2, 8.1 |
| 2.2 | 3.2, 5.1, 6.2, 8.1 |
| 2.3 | 3.3, 8.1 |
| 2.4 | 3.2, 6.2 |
| 2.5 | 6.2 |
| 2.6 | 6.2 |
| 3.1 | 4.1, 5.2 |
| 3.2 | 4.1 |
| 3.3 | 4.1 |
| 3.4 | 4.1 |
| 3.5 | 4.1 |
| 3.6 | 4.1 |
| 3.7 | 4.1 |
| 4.1 | 4.2, 5.2 |
| 4.2 | 4.2 |
| 4.3 | 4.2 |
| 4.4 | 4.2 |
| 4.5 | 4.2 |
| 5.1 | 4.3, 5.2 |
| 5.2 | 4.3 |
| 5.3 | 4.3 |
| 5.4 | 4.3 |
| 5.5 | 4.3 |
| 6.1 | 4.4, 5.2, 6.3 |
| 6.2 | 5.2, 6.3 |
| 6.3 | 6.3 |
| 6.4 | 4.4 |
| 6.5 | 6.3 |
| 7.1 | 4.4 |
| 7.2 | 4.4, 8.2 |
| 7.3 | 4.4, 8.2 |
| 7.4 | 4.4 |
| 8.1 | 7 |
| 8.2 | 6.4, 8.3 |
| 8.3 | 6.4, 8.3 |
| 8.4 | 6.4, 8.3 |
| 8.5 | 6.4 |
| 9.1 | 1 |
| 9.2 | 1 |
| 9.3 | 1 |

---

## Task Dependencies

```
Task 1 (スキーマ変更)
    ↓
Task 2 (CSVパーサー) ─────────────┐
    ↓                           │
Task 3 (原曲マッチング)           │── 並列可能 (P)
    ↓                           │
Task 6.1 (CSVアップロードUI) ─────┘
    ↓
Task 4 (インポートサービス)
    ↓
Task 5 (APIエンドポイント)
    ↓
Task 6.2-6.4 (残りのUI)
    ↓
Task 7 (ナビゲーション統合)
    ↓
Task 8 (テスト)
```

**並列実行可能なタスク:**
- Task 2.1 (P), 2.2 (P): CSV パース機能は独立して開発可能
- Task 3.1 (P): 完全一致マッチングはパーサーと並列開発可能
- Task 6.1 (P): CSV アップロード UI はバックエンドと並列開発可能
- Task 8.1 (P): ユニットテストは機能実装と並列開発可能
