# Implementation Plan

## Task 1: 管理者セッション取得サーバー関数の作成

- [x] 1. 管理者セッション取得サーバー関数の作成
- [x] 1.1 getAdminUserサーバー関数を実装する
  - 既存の`getUser`サーバー関数と同じパターンで管理者用セッション取得関数を作成
  - `authMiddleware`を使用してリクエストヘッダー（Cookie）を転送
  - セッション情報をコンテキストから取得して返却
  - セッションが存在しない場合はnullを返却
  - _Requirements: 1.1, 1.2, 3.1_

## Task 2: 管理画面ルートの認証処理を修正

- [x] 2. 管理画面ルートの認証処理を修正
- [x] 2.1 _admin.tsxのbeforeLoadをサーバー関数パターンに変更する
  - `authClient.getSession()`直接呼び出しを`getAdminUser()`サーバー関数に置き換え
  - サーバー関数からセッション情報を取得
  - 既存のロール検証ロジック（admin権限チェック）を維持
  - 既存の403 Forbiddenページ表示ロジックを維持
  - 子ルートへのコンテキスト伝播を維持
  - _Requirements: 1.3, 1.4, 3.2, 3.3_

## Task 3: エラーハンドリングの実装

- [x] 3. エラーハンドリングの実装
- [x] 3.1 セッション取得失敗時のエラーハンドリングを追加する
  - `getAdminUser`呼び出し時の例外をキャッチ
  - ネットワークエラーやサーバーエラー時はログインページへリダイレクト
  - redirect例外はそのままスローして正常に処理
  - _Requirements: 3.2_

## Task 4: 動作検証

- [x] 4. 動作検証
- [x] 4.1 (P) 手動テストでセッション永続化を確認する
  - 管理者としてログイン後、ページを更新してもログイン状態が維持されることを確認
  - 管理画面内でナビゲーションしてもセッションが維持されることを確認
  - 未認証状態でアクセスするとログインページにリダイレクトされることを確認
  - 非管理者でアクセスすると403ページが表示されることを確認
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 4.2 (P) セッション期限切れ時の動作を確認する
  - セッション期限切れ後にページを更新するとログインページにリダイレクトされることを確認
  - _Requirements: 1.4_

