# Implementation Plan

## Task Summary

| Category | Count |
|----------|-------|
| Major Tasks | 8 |
| Sub-tasks | 26 |
| Requirements Covered | 1, 2, 3, 4, 5, 6, 8 |

## Requirement Coverage

| Requirement | Task(s) |
|-------------|---------|
| 1 (原曲紐付け管理) | 1.1, 2.1, 2.2, 2.3 |
| 2 (トラック派生関係) | 1.1, 3.1, 3.2, 3.3 |
| 3 (リリース公開リンク) | 1.2, 4.1, 4.2, 4.3 |
| 4 (トラック公開リンク) | 1.2, 5.1, 5.2, 5.3 |
| 5 (JANコード管理) | 1.3, 6.1, 6.2, 6.3 |
| 6 (ISRC管理) | 1.3, 7.1, 7.2, 7.3 |
| 8 (SQLite変換) | 1.1, 1.2, 1.3 |

**Note**: Requirement 7（テンポ管理）は設計フェーズで対象外となった。

---

## Tasks

- [ ] 1. データベーススキーマとID生成の実装
- [ ] 1.1 トラック関連テーブルのスキーマを実装する
  - 原曲紐付けテーブルを定義し、トラック×公式楽曲×順序の一意性を保証する
  - 派生関係テーブルを定義し、自己参照禁止と重複禁止の制約を設定する
  - 開始秒・終了秒フィールドとconfidenceフィールドを追加する
  - 新規IDプレフィックス（to_, td_）をID生成ユーティリティに追加する
  - 既存のtracksテーブルおよびofficialSongsテーブルへの外部キー参照を設定する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 8.1, 8.2, 8.3, 8.5_

- [ ] 1.2 (P) 公開リンクテーブルのスキーマを実装する
  - リリース公開リンクテーブルを定義し、一意性制約とURL重複禁止を設定する
  - トラック公開リンクテーブルを定義し、一意性制約とURL重複禁止を設定する
  - platformsテーブル（code主キー形式）への外部キー参照を設定する
  - 新規IDプレフィックス（rp_, tp_）をID生成ユーティリティに追加する
  - visibility、公開日、取り下げ日、公式アップロードフラグを追加する
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 8.1, 8.2, 8.6_

- [ ] 1.3 (P) 識別コードテーブルのスキーマを実装する
  - JANコードテーブルを定義し、グローバル一意性とis_primary制約を設定する
  - ISRCテーブルを定義し、トラック×ISRCの一意性とis_primary制約を設定する
  - 条件付きユニークインデックスをwhere句で実装する（is_primary = 1）
  - 新規IDプレフィックス（rj_, ti_）をID生成ユーティリティに追加する
  - _Requirements: 5.1, 5.3, 5.4, 6.1, 6.3, 6.4, 8.1, 8.2, 8.5_

- [ ] 1.4 バリデーションスキーマを実装する
  - JANコード形式（8桁または13桁）のZodバリデーションを実装する
  - ISRC形式（12桁: CC-XXX-YY-NNNNN）のZodバリデーションを実装する
  - 国コード形式（ISO 3166-1 alpha-2）のZodバリデーションを実装する
  - 秒数の整合性チェック（開始秒 <= 終了秒）を実装する
  - confidenceの範囲チェック（0-100）を実装する
  - insert/update/selectスキーマをdrizzle-zodで生成する
  - スキーマをschema/index.tsからエクスポートする
  - _Requirements: 5.2, 6.2, 8.4_

- [ ] 2. 原曲紐付け機能の実装
- [ ] 2.1 原曲紐付けのAPIエンドポイントを実装する
  - 一覧取得（GET）、追加（POST）、更新（PUT）、削除（DELETE）を実装する
  - 親トラックの存在チェックを行い、404エラーを返す
  - 公式楽曲存在チェックと紐付けのRESTRICT動作を実装する
  - 一意性制約違反時の409エラーハンドリングを実装する
  - _Requirements: 1.1, 1.2, 1.5, 1.6_

- [ ] 2.2 原曲紐付けのUIセクションを実装する
  - トラック詳細画面に原曲紐付けセクションを追加する
  - 公式楽曲の検索・選択機能を実装する（SearchableSelect使用）
  - 順序（part_position）、開始秒・終了秒、confidence入力を実装する
  - 追加・編集・削除のダイアログを実装する
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ] 2.3 原曲紐付けのデータフェッチを実装する
  - TanStack Queryで原曲紐付けデータの取得・キャッシュを実装する
  - 追加・更新・削除のミューテーションを実装する
  - ローディング・エラー状態の表示を実装する
  - _Requirements: 1.1_

- [ ] 3. トラック派生関係機能の実装
- [ ] 3.1 派生関係のAPIエンドポイントを実装する
  - 一覧取得（GET）、追加（POST）、削除（DELETE）を実装する
  - 自己参照（child = parent）の禁止チェックを実装する
  - 同一派生関係の重複チェックを実装する
  - 親トラック削除時のRESTRICT、子トラック削除時のCASCADE動作を確認する
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 3.2 派生関係のUIセクションを実装する
  - トラック詳細画面に派生関係セクションを追加する
  - 派生元トラックの検索・選択機能を実装する
  - 備考（notes）入力を実装する
  - フラットリスト形式で派生関係を表示する
  - 削除確認ダイアログを実装する
  - _Requirements: 2.1, 2.6_

- [ ] 3.3 派生関係のデータフェッチを実装する
  - TanStack Queryで派生関係データの取得・キャッシュを実装する
  - 追加・削除のミューテーションを実装する
  - _Requirements: 2.1_

- [ ] 4. リリース公開リンク機能の実装
- [ ] 4.1 リリース公開リンクのAPIエンドポイントを実装する
  - 一覧取得（GET）、追加（POST）、更新（PUT）、削除（DELETE）を実装する
  - 親リリースの存在チェックを実装する
  - URL重複と一意性制約違反のエラーハンドリングを実装する
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 4.2 リリース公開リンクのUIセクションを実装する
  - リリース詳細画面に公開リンクセクションを追加する
  - プラットフォーム選択（platformsマスター）を実装する
  - URL、プラットフォーム内ID、visibility、公開日、is_official入力を実装する
  - 国コード入力を実装する
  - _Requirements: 3.1, 3.4, 3.5, 3.6, 3.7_

- [ ] 4.3 リリース公開リンクのデータフェッチを実装する
  - TanStack Queryでデータ取得・キャッシュを実装する
  - CRUD操作のミューテーションを実装する
  - _Requirements: 3.1_

- [ ] 5. トラック公開リンク機能の実装
- [ ] 5.1 (P) トラック公開リンクのAPIエンドポイントを実装する
  - 一覧取得（GET）、追加（POST）、更新（PUT）、削除（DELETE）を実装する
  - 親トラックの存在チェックを実装する
  - URL重複と一意性制約違反のエラーハンドリングを実装する
  - _Requirements: 4.1, 4.2, 4.3_

- [ ] 5.2 (P) トラック公開リンクのUIセクションを実装する
  - トラック詳細画面に公開リンクセクションを追加する
  - プラットフォーム選択、URL入力、各種フィールドを実装する
  - _Requirements: 4.1, 4.4, 4.5, 4.6_

- [ ] 5.3 トラック公開リンクのデータフェッチを実装する
  - TanStack Queryでデータ取得・キャッシュを実装する
  - CRUD操作のミューテーションを実装する
  - _Requirements: 4.1_

- [ ] 6. JANコード管理機能の実装
- [ ] 6.1 (P) JANコードのAPIエンドポイントを実装する
  - 一覧取得（GET）、追加（POST）、更新（PUT）、削除（DELETE）を実装する
  - 親リリースの存在チェックを実装する
  - グローバル一意性チェックとis_primary制約を実装する
  - 形式不正時のエラーメッセージを実装する
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [ ] 6.2 (P) JANコードのUIセクションを実装する
  - リリース詳細画面にJANコードセクションを追加する
  - JANコード入力とバリデーションエラー表示を実装する
  - is_primary切り替え（1件のみ許可）を実装する
  - label、国コード入力を実装する
  - _Requirements: 5.1, 5.2, 5.4, 5.5, 5.6_

- [ ] 6.3 JANコードのデータフェッチを実装する
  - TanStack Queryでデータ取得・キャッシュを実装する
  - CRUD操作のミューテーションを実装する
  - _Requirements: 5.1_

- [ ] 7. ISRC管理機能の実装
- [ ] 7.1 (P) ISRCのAPIエンドポイントを実装する
  - 一覧取得（GET）、追加（POST）、更新（PUT）、削除（DELETE）を実装する
  - 親トラックの存在チェックを実装する
  - トラック×ISRCの一意性チェックとis_primary制約を実装する
  - 形式不正時のエラーメッセージを実装する
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [ ] 7.2 (P) ISRCのUIセクションを実装する
  - トラック詳細画面にISRCセクションを追加する
  - ISRC入力とバリデーションエラー表示を実装する
  - is_primary切り替え（1件のみ許可）を実装する
  - assigned_at、source入力を実装する
  - _Requirements: 6.1, 6.2, 6.4, 6.5, 6.6_

- [ ] 7.3 ISRCのデータフェッチを実装する
  - TanStack Queryでデータ取得・キャッシュを実装する
  - CRUD操作のミューテーションを実装する
  - _Requirements: 6.1_

- [ ] 8. 統合テストと最終確認
- [ ] 8.1 データベースマイグレーションを実行する
  - db:pushでスキーマをデータベースに反映する
  - 外部キー制約とインデックスが正しく作成されていることを確認する
  - _Requirements: 8.1, 8.2, 8.5, 8.6_

- [ ] 8.2 CRUDフロー全体のE2Eテストを実施する
  - トラック詳細画面で各機能（原曲、派生、公開リンク、ISRC）の追加・編集・削除を確認する
  - リリース詳細画面で各機能（公開リンク、JAN）の追加・編集・削除を確認する
  - CASCADE/RESTRICT動作を確認する（親削除時の挙動）
  - _Requirements: 1.1, 1.6, 2.1, 2.4, 2.5, 3.1, 4.1, 5.1, 6.1_

- [ ] 8.3 バリデーションエラーの表示を確認する
  - JAN形式不正時のエラーメッセージを確認する
  - ISRC形式不正時のエラーメッセージを確認する
  - 自己参照禁止エラーを確認する
  - 重複登録時の409エラーを確認する
  - _Requirements: 2.2, 5.2, 6.2, 8.4_
