# Implementation Plan

## Task 1. データ層: スキーマとバリデーション定義

- [x] 1.1 (P) トラックテーブルのスキーマを定義する
  - リリースに紐づくトラック情報を保持するテーブルを作成
  - トラック名（必須）、日本語名・英語名（任意）、トラック番号（1以上の整数）を定義
  - ディスクIDはNULL許容とし、単曲公開に対応
  - ディスク有無で異なる条件付き一意制約を設定（disc_id IS NULLの場合はリリース内、disc_id指定時はディスク内でトラック番号の一意性を保証）
  - リリース削除時・ディスク削除時のカスケード削除を設定
  - _Requirements: 1.2, 1.6, 1.7, 2.1, 2.2, 2.3, 2.4, 7.1, 7.2, 7.5_

- [x] 1.2 (P) クレジットテーブルのスキーマを定義する
  - トラックごとのアーティストクレジット情報を保持するテーブルを作成
  - 盤面表記（必須）、アーティスト（必須）、別名義・別名義種別（任意）、表示順（任意）を定義
  - 同一トラック・同一アーティスト・同一別名義の重複を防止する一意制約を設定
  - トラック削除時はカスケード削除、アーティスト削除時は拒否（RESTRICT）、別名義削除時はNULL設定を適用
  - _Requirements: 4.2, 4.3, 4.6, 7.3, 7.4, 7.6_

- [x] 1.3 (P) クレジット役割テーブルのスキーマを定義する
  - クレジットに対する役割の多対多関係を管理するテーブルを作成
  - クレジットID、役割コード、役割内表示順を複合主キーとして定義
  - クレジット削除時のカスケード削除を設定
  - 役割マスターへの参照制約を設定
  - _Requirements: 5.1, 5.2, 5.4_

- [x] 1.4 バリデーションスキーマを定義する
  - トラック登録・更新用のZodスキーマを作成（トラック名必須、トラック番号1以上）
  - クレジット登録・更新用のZodスキーマを作成（盤面表記必須、アーティストID必須）
  - 役割追加用のZodスキーマを作成（役割コード必須、表示順1以上）
  - 既存のdrizzle-zodパターンに従い、insertスキーマとupdateスキーマを分離
  - _Requirements: 1.5, 7.5, 7.6_

- [x] 1.5 データベースマイグレーションを実行する
  - マイグレーションファイルを生成し、条件付きインデックスが正しく出力されているか確認
  - 必要に応じてマイグレーションファイルを手動修正（Drizzle部分インデックスの既知問題対応）
  - マイグレーションを実行してテーブルを作成
  - 1.1, 1.2, 1.3のスキーマ定義が完了している必要あり
  - _Requirements: 2.3, 2.4_

## Task 2. API層: トラック管理エンドポイント

- [x] 2.1 トラックCRUD APIを実装する
  - リリース配下のトラック一覧取得エンドポイントを作成（クレジット情報の要約を含む）
  - トラック登録エンドポイントを作成（ディスク有無に対応、トラック番号の一意性検証）
  - トラック更新エンドポイントを作成
  - トラック削除エンドポイントを作成
  - 存在しないリリース・トラックへのアクセス時は404エラーを返却
  - トラック番号重複時は409 Conflictエラーを返却
  - _Requirements: 1.2, 1.3, 1.4, 2.1, 2.2, 2.5, 6.3, 6.4_

- [x] 2.2 トラック並び順変更APIを実装する
  - 上へ移動・下へ移動のreorderエンドポイントを作成
  - 隣接トラックとのトラック番号入れ替えを実装
  - 最上位・最下位での移動操作時は適切なエラーを返却
  - ディスク有無に応じたスコープでの並び順管理を実装
  - _Requirements: 3.1, 3.2, 3.5_

- [x] 2.3 クレジットCRUD APIを実装する
  - トラック配下のクレジット一覧取得エンドポイントを作成（役割情報を結合して取得）
  - クレジット登録エンドポイントを作成（アーティスト・別名義の重複検証）
  - クレジット更新エンドポイントを作成
  - クレジット削除エンドポイントを作成（関連する役割も削除）
  - 重複クレジット登録時は409 Conflictエラーを返却
  - _Requirements: 4.2, 4.4, 4.5, 4.6, 4.7_

- [x] 2.4 クレジット役割追加・削除APIを実装する
  - 役割追加エンドポイントを作成（役割コード、表示順を受け取り）
  - 役割削除エンドポイントを作成（役割コード、表示順をパスパラメータで受け取り）
  - マスターデータに存在しない役割コードの場合は400エラーを返却
  - 重複する役割・表示順の組み合わせは409エラーを返却
  - _Requirements: 5.1, 5.3, 5.4, 5.5_

## Task 3. UI層: トラック一覧セクション

- [x] 3.1 トラック一覧セクションを実装する
  - 作品詳細画面にトラック一覧を表示するセクションを追加
  - ディスクごとにグループ化したトラック一覧を表示
  - ディスクなしトラック（単曲）は別セクションとして表示
  - 各トラックのトラック番号、トラック名、クレジット要約を表示
  - トラックがない場合は「トラックがありません」メッセージを表示
  - 既存のディスクカード・サークルカードと同様のUIパターンを適用
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 3.2 トラック並び順変更UIを実装する
  - 各トラック行に上へ移動・下へ移動ボタンを配置
  - 最上位トラックでは上へ移動ボタンを無効化
  - 最下位トラックでは下へ移動ボタンを無効化
  - 移動操作後にトラック一覧を再取得して表示を更新
  - 既存のイベントシリーズ並び順変更と同様のUIパターンを適用
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

## Task 4. UI層: トラック登録・編集ダイアログ

- [x] 4.1 トラック追加ボタンと登録ダイアログを実装する
  - トラック追加ボタンをセクションヘッダーに配置
  - トラック登録ダイアログを作成（トラック名、日本語名、英語名、トラック番号、ディスク選択）
  - ディスク選択は「なし」を含むドロップダウンとして実装
  - トラック番号は自動採番（既存最大値+1）をデフォルト値として設定
  - バリデーションエラー時はフィールドレベルでエラーメッセージを表示
  - 保存成功後にトラック一覧を再取得
  - _Requirements: 1.1, 1.2, 1.5, 1.6, 1.7, 2.1, 2.2_

- [x] 4.2 トラック編集・削除機能を実装する
  - 各トラック行に編集・削除ボタンを配置
  - トラック編集ダイアログを作成（登録ダイアログを再利用し、既存値をプリセット）
  - 削除時は確認ダイアログを表示してから実行
  - 編集・削除成功後にトラック一覧を再取得
  - _Requirements: 1.3, 1.4_

## Task 5. UI層: クレジット管理ダイアログ

- [x] 5.1 クレジット一覧表示と追加ボタンを実装する
  - トラック詳細エリアにクレジット一覧を表示
  - クレジット追加ボタンを配置
  - 各クレジットの盤面表記、アーティスト名、役割一覧を表示
  - _Requirements: 4.1, 4.7, 6.4_

- [x] 5.2 クレジット登録ダイアログを実装する
  - クレジット登録ダイアログを作成（アーティスト選択、別名義選択、盤面表記、表示順）
  - アーティスト選択は検索可能なセレクトとして実装
  - 別名義選択は選択したアーティストに紐づく別名義のみをフィルタ表示
  - 盤面表記はアーティスト名または別名義名で自動入力し、手動編集可能に
  - バリデーションエラー・重複エラー時はエラーメッセージを表示
  - _Requirements: 4.1, 4.2, 4.3, 4.6_

- [x] 5.3 役割選択機能を実装する
  - クレジット登録・編集ダイアログ内に役割選択エリアを追加
  - 役割マスターから選択可能な役割をチェックボックス形式で表示
  - 複数役割の選択を可能に
  - 役割の表示順は選択順で自動設定
  - クレジット保存時に役割も同時に保存
  - _Requirements: 5.1, 5.2, 5.5_

- [x] 5.4 クレジット編集・削除機能を実装する
  - 各クレジット行に編集・削除ボタンを配置
  - クレジット編集ダイアログを作成（登録ダイアログを再利用し、既存値と役割をプリセット）
  - 削除時は確認ダイアログを表示（関連する役割も削除される旨を表示）
  - 編集・削除成功後にクレジット一覧を再取得
  - _Requirements: 4.4, 4.5, 5.3_

## Task 6. 統合とエラーハンドリング

- [x] 6.1 APIクライアント関数を実装する
  - トラックAPI関数（一覧、登録、更新、削除、並び順変更）を追加
  - クレジットAPI関数（一覧、登録、更新、削除）を追加
  - 役割API関数（追加、削除）を追加
  - 既存のfetchWithAuthパターンに従い、型安全なAPIクライアントを実装
  - _Requirements: 1.2, 1.3, 1.4, 4.2, 4.4, 4.5, 5.1, 5.3_

- [x] 6.2 TanStack Queryの設定を追加する
  - トラック一覧のクエリキーとフェッチ関数を設定
  - クレジット一覧のクエリキーとフェッチ関数を設定
  - 登録・更新・削除操作後のキャッシュ無効化を設定
  - 楽観的更新は適用せず、操作完了後に再フェッチ
  - _Requirements: 6.1, 6.3_

- [x] 6.3 エラーハンドリングを統合する
  - バリデーションエラー（400）のフィールドレベル表示
  - 一意制約違反（409）のユーザーフレンドリーなエラーメッセージ表示
  - アーティスト削除拒否時（RESTRICT）のエラーメッセージ表示
  - APIクライアントのエラーハンドリングを統一
  - _Requirements: 1.5, 2.5, 4.6, 7.3_

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1 - 1.7 | 1.1, 1.4, 2.1, 4.1, 4.2 |
| 2.1 - 2.5 | 1.1, 1.5, 2.1, 4.1 |
| 3.1 - 3.5 | 2.2, 3.2 |
| 4.1 - 4.7 | 1.2, 1.4, 2.3, 5.1, 5.2, 5.4 |
| 5.1 - 5.5 | 1.3, 1.4, 2.4, 5.3, 5.4 |
| 6.1 - 6.5 | 2.1, 3.1, 6.2 |
| 7.1 - 7.6 | 1.1, 1.2, 1.4, 6.3 |
