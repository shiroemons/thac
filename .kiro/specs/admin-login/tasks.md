# Implementation Plan

## Tasks

- [x] 1. データベーススキーマ拡張
- [x] 1.1 ユーザーテーブルにロール関連フィールドを追加
  - userテーブルにrole（デフォルト: "user"）、banned、banReason、banExpiresフィールドを追加
  - sessionテーブルにimpersonatedByフィールドを追加
  - Better-Auth adminプラグインが期待するスキーマに準拠
  - _Requirements: 3.1_

- [x] 1.2 マイグレーションの実行と検証
  - スキーマ変更のマイグレーションファイルを生成
  - ローカルデータベースにマイグレーションを適用
  - 既存データへの影響がないことを確認
  - _Requirements: 3.1_

- [x] 2. Better-Auth adminプラグイン設定
- [x] 2.1 サーバー側のadminプラグイン追加
  - packages/authにadminプラグインをインポートして設定
  - defaultRoleを"user"、adminRolesを["admin"]に設定
  - 既存の認証設定との統合を確認
  - _Requirements: 2.1, 3.2, 4.1_

- [x] 2.2 (P) クライアント側のadminClientプラグイン追加
  - apps/webのauth-clientにadminClientプラグインを追加
  - ロール情報がセッションから取得できることを確認
  - _Requirements: 2.1, 3.2_

- [x] 3. 管理者ログインUI実装
- [x] 3.1 (P) 管理者専用ログインフォームコンポーネント作成
  - 既存のSignInFormを参考にAdminLoginFormを作成
  - メールアドレスとパスワードの入力フィールドを提供
  - TanStack FormとZodによるバリデーションを実装
  - 無効なメール形式、空パスワードのエラーメッセージ表示
  - _Requirements: 1.2, 6.1, 6.2_

- [x] 3.2 ログインボタンの状態制御
  - 入力が空の場合はボタンを無効化
  - 入力が有効な場合はボタンを有効化
  - 送信中はローディング状態を表示しフォームを無効化
  - _Requirements: 1.3, 1.4, 6.3_

- [x] 3.3 認証処理とエラーハンドリング
  - authClient.signIn.emailを呼び出して認証実行
  - 認証成功時に管理者ダッシュボードへリダイレクト
  - 認証失敗時にエラーメッセージを表示
  - ロール検証エラー時は「管理者権限がありません」を表示
  - タイミング攻撃対策として同一のエラーメッセージを使用
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 3.2, 3.3_

- [x] 4. 管理者ルート構造の実装
- [x] 4.1 (P) 管理者ログインページのルート作成
  - /admin/loginルートを作成
  - AdminLoginFormをレンダリング
  - 管理者向けのUIスタイリングを適用
  - _Requirements: 1.1_

- [x] 4.2 管理者レイアウトルートの作成
  - /admin配下を保護するレイアウトルートを作成
  - beforeLoadフックで認証状態を確認
  - 未認証ユーザーを/admin/loginにリダイレクト
  - 認証済みユーザーの情報を子ルートにcontextで伝播
  - _Requirements: 5.1, 5.3_

- [x] 4.3 (P) 403 Forbiddenページの作成
  - アクセス権限がないことを通知するエラーページを作成
  - シンプルで明確なエラーメッセージを表示
  - Admin用ログインページへのリンクは提供しない（セキュリティ考慮）
  - _Requirements: 5.2_

- [x] 4.4 管理者ロール検証の実装
  - beforeLoadでユーザーロールを確認
  - role !== "admin"の場合は403ページを表示
  - 管理者の場合のみ子ルートへのアクセスを許可
  - _Requirements: 5.2, 5.3_

- [x] 5. セッション管理とログアウト
- [x] 5.1 (P) 管理者ダッシュボードの仮ページ作成
  - /adminルートのインデックスページを作成
  - ログイン成功後のリダイレクト先として機能
  - ログアウトボタンを配置
  - _Requirements: 2.2_

- [x] 5.2 ログアウト機能の実装
  - authClient.signOutを呼び出してセッション無効化
  - ログアウト完了後にAdmin用ログイン画面へリダイレクト
  - _Requirements: 4.3, 4.4_

- [x] 5.3 セッション有効期限の処理
  - セッション切れ時に自動的にログイン画面へリダイレクト
  - Better-Authのセッション管理機能を活用
  - _Requirements: 4.1, 4.2_

- [x] 6. 統合テストと動作確認
- [x] 6.1 管理者ログインフローのE2Eテスト
  - 管理者ユーザーでのログイン成功フローを検証
  - 一般ユーザーでのログイン時にエラーメッセージが表示されることを確認
  - 無効な認証情報でのエラー表示を確認
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 3.2, 3.3_

- [x] 6.2 保護ルートのアクセス制御テスト
  - 未認証ユーザーが/admin配下にアクセスした際のリダイレクトを確認
  - 一般ユーザーが/admin配下にアクセスした際の403表示を確認
  - 管理者ユーザーが正常にアクセスできることを確認
  - _Requirements: 5.1, 5.2, 5.3_

- [x] 6.3 型チェックとリント実行
  - bun run check-typesで型エラーがないことを確認
  - bun run checkでリント・フォーマットエラーがないことを確認
  - _Requirements: 全体_
