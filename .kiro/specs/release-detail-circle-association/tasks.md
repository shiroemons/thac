# Implementation Plan

## Task Overview

作品詳細画面とサークル関連付け機能の実装タスク。

**要件カバレッジ**: 6要件（1.1-1.7, 2.1-2.5, 3.1-3.7, 4.1-4.5, 5.1-5.3, 6.1-6.6）

---

## Tasks

- [x] 1. DBスキーマ変更とバリデーション追加
- [x] 1.1 (P) release_circlesテーブルのカラム名変更
  - `role`カラムを`participation_type`にリネーム
  - 複合主キーの更新（releaseId, circleId, participationType）
  - マイグレーション生成と適用
  - _Requirements: 6.2, 6.4_

- [x] 1.2 (P) サークル関連付け用バリデーションスキーマ追加
  - 参加形態の定数定義（host, co-host, participant, guest, split_partner）
  - 新規関連付け用スキーマ（circleId必須、participationType任意でデフォルトhost）
  - 更新用スキーマ（participationType, position両方任意）
  - _Requirements: 6.2, 6.4_

- [x] 2. サークル関連付けAPI実装
- [x] 2.1 関連サークル一覧取得エンドポイント
  - 作品IDに紐づくサークル一覧をposition順で取得
  - サークル情報（id, name, nameJa, nameEn）を結合して返却
  - 作品が存在しない場合は404エラー
  - _Requirements: 6.1, 6.5_

- [x] 2.2 サークル関連付け追加エンドポイント
  - 作品にサークルを関連付け（release_circlesに登録）
  - 参加形態はデフォルトでhostを設定
  - 既存の同一組み合わせ（releaseId, circleId, participationType）がある場合は409エラー
  - リクエストバリデーション適用
  - _Requirements: 6.2, 6.5, 6.6_

- [x] 2.3 関連付け更新エンドポイント
  - 参加形態または表示順を更新
  - 対象の関連付けが存在しない場合は404エラー
  - _Requirements: 6.4, 6.5_

- [x] 2.4 関連付け解除エンドポイント
  - 作品とサークルの関連付けを削除
  - 複合主キーのためparticipationTypeをクエリパラメータで指定
  - 対象が存在しない場合は404エラー
  - _Requirements: 6.3, 6.5_

- [x] 2.5 サークル関連APIをreleasesルーターに統合
  - ネストリソースパターン（/:releaseId/circles）でマウント
  - AdminContext認証ミドルウェア適用
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [x] 3. フロントエンドAPIクライアント追加
- [x] 3.1 (P) releaseCirclesApiの実装
  - list: 関連サークル一覧取得
  - add: サークル関連付け追加
  - update: 関連付け更新（参加形態・順序）
  - remove: 関連付け解除（participationTypeをクエリパラメータで送信）
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [x] 3.2 (P) 参加形態の型定義と表示ラベル
  - ParticipationType型（host, co-host, participant, guest, split_partner）
  - 日本語ラベルマッピング（主催、共同主催、参加、ゲスト、スプリット）
  - ReleaseCircle、ReleaseCircleWithCircleインターフェース
  - _Requirements: 3.4_

- [x] 4. 作品詳細画面の基盤実装
- [x] 4.1 詳細画面ルート作成
  - TanStack Routerの動的ルート（$id.tsx）として実装
  - 作品データの取得とローディング状態管理
  - 作品が存在しない場合のエラー画面表示
  - 一覧画面へ戻るリンク提供
  - _Requirements: 1.1, 1.5, 1.7_

- [x] 4.2 作品基本情報の表示
  - 作品名、日本語名、英語名、カタログ番号、タイプ、発売日、メモを表示
  - パンくずナビゲーション（作品管理 > 作品名）
  - 表示モードのレイアウト
  - _Requirements: 1.2, 1.6_

- [x] 4.3 作品基本情報の編集機能
  - 編集ボタンで編集モードに切り替え
  - 編集フォームのバリデーション
  - 保存時にAPI送信、成功で表示モードに戻る
  - エラー時のメッセージ表示
  - _Requirements: 1.3, 1.4_

- [x] 5. ディスク管理セクション実装
- [x] 5.1 ディスク一覧表示
  - 作品に紐づくディスクをディスク番号順に表示
  - ディスクが0件の場合は「ディスクが登録されていません」メッセージ
  - _Requirements: 2.1, 2.5_

- [x] 5.2 ディスクの追加・編集・削除操作
  - ディスク追加ボタンでダイアログ表示
  - 各ディスクの編集ボタンで編集ダイアログ表示
  - 削除ボタンで確認ダイアログ後に削除実行
  - 既存のdiscsApiを活用
  - _Requirements: 2.2, 2.3, 2.4_

- [x] 6. サークル関連付けセクション実装
- [x] 6.1 関連サークル一覧表示
  - 作品に関連付けられたサークルをposition順で表示
  - 参加形態ラベルを日本語で表示
  - サークルが0件の場合は「サークルが関連付けられていません」メッセージ
  - _Requirements: 3.1, 3.7_

- [x] 6.2 サークル追加機能
  - サークル追加ボタンでサークル選択ダイアログを起動
  - 選択確定時に関連付けAPIを呼び出し
  - 追加成功後に一覧を再取得
  - _Requirements: 3.2, 3.3_

- [x] 6.3 関連サークルの削除機能
  - 削除ボタンで確認ダイアログ表示
  - 確認後に関連付け解除APIを呼び出し
  - _Requirements: 3.5_

- [x] 6.4 関連サークルの順序変更機能
  - 上下ボタン（ChevronUp/ChevronDown）で順序変更
  - position更新APIを呼び出し
  - 一覧の並び順を即時反映
  - _Requirements: 3.6_

- [x] 7. サークル選択ダイアログ実装
- [x] 7.1 サークル一覧表示と検索
  - 登録済みサークルの一覧表示
  - 検索ボックスでサークル名による絞り込み（デバウンス300ms）
  - 検索結果が0件の場合は「該当するサークルが見つかりません」メッセージ
  - _Requirements: 4.1, 4.2, 4.5_

- [x] 7.2 サークル選択と参加形態設定
  - 既に関連付け済みのサークルを選択不可（または選択済み表示）
  - 参加形態のプルダウン選択（デフォルト: 主催）
  - 選択確定でダイアログを閉じ、コールバック実行
  - _Requirements: 4.3, 4.4, 3.4_

- [x] 8. 作品一覧画面の導線追加
- [x] 8.1 詳細画面への導線実装
  - 各作品行に詳細画面へのリンクを追加（作品名クリックまたは詳細ボタン）
  - 既存の編集ダイアログ機能は維持（簡易編集用途）
  - _Requirements: 5.1, 5.2, 5.3_

- [x] 9. 統合テスト
- [x] 9.1* サークル関連付けAPIの統合テスト
  - 関連付け追加（成功、重複エラー、作品不存在エラー）
  - 関連付け削除（成功、不存在エラー）
  - 順序更新
  - 作品削除時のCASCADE削除確認
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_

---

## Requirements Coverage

| 要件 | タスク |
|-----|-------|
| 1.1, 1.5, 1.7 | 4.1 |
| 1.2, 1.6 | 4.2 |
| 1.3, 1.4 | 4.3 |
| 2.1, 2.5 | 5.1 |
| 2.2, 2.3, 2.4 | 5.2 |
| 3.1, 3.7 | 6.1 |
| 3.2, 3.3 | 6.2 |
| 3.4 | 3.2, 7.2 |
| 3.5 | 6.3 |
| 3.6 | 6.4 |
| 4.1, 4.2, 4.5 | 7.1 |
| 4.3, 4.4 | 7.2 |
| 5.1, 5.2, 5.3 | 8.1 |
| 6.1, 6.5 | 2.1 |
| 6.2, 6.5, 6.6 | 2.2 |
| 6.3, 6.5 | 2.4 |
| 6.4, 6.5 | 2.3 |
| 6.1-6.4 | 2.5, 3.1 |

**全要件カバー済み** ✅
