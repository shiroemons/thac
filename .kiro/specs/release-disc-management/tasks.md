# Implementation Plan

## Tasks

- [x] 1. データベーススキーマとバリデーション定義
- [x] 1.1 リリーステーブルスキーマを定義する
  - リリースの基本情報（名前、日本語名、英語名、カタログ番号、発売日、タイプ）を保持するテーブル
  - イベント開催日への任意参照（削除時にNULL設定）
  - 自由メタ情報用のnotesフィールド
  - 発売日、タイプ、イベント開催日ID、カタログ番号にインデックス
  - 自動タイムスタンプ（作成日時、更新日時）
  - _Requirements: 1.1, 1.2, 1.3_

- [x] 1.2 ディスクテーブルスキーマを定義する
  - リリースに属するディスク情報を保持
  - ディスク番号は同一リリース内でユニーク制約
  - 親リリース削除時にカスケード削除
  - 自動タイムスタンプ（作成日時、更新日時）
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 1.3 リリースサークル関連テーブルスキーマを定義する
  - リリースとサークルの関連（役割付き）を保持
  - 複合主キー（リリースID、サークルID、役割）
  - サークル削除時は参照保護、リリース削除時はカスケード
  - 表示順を管理するpositionフィールド
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 1.4 バリデーションスキーマを定義する
  - リリースタイプの定数定義（album, single, ep, digital_single, video_single）
  - リリースの挿入・更新用Zodスキーマ
  - ディスクの挿入・更新用Zodスキーマ
  - 日付フォーマット（YYYY-MM-DD）バリデーション
  - スキーマエクスポートをindexに追加
  - _Requirements: 1.4, 2.4_

- [x] 2. リリースAPIエンドポイント実装
- [x] 2.1 リリース一覧取得APIを実装する
  - ページネーション対応（page, limit）
  - リリース名での検索機能
  - リリースタイプでのフィルタ機能
  - ディスク数を含めて返却
  - 発売日と名前でソート
  - _Requirements: 12.1_

- [x] 2.2 リリース詳細取得APIを実装する
  - リリースIDによる個別取得
  - 関連ディスク一覧をディスク番号順で含める
  - 存在しないIDは404エラー
  - _Requirements: 12.1_

- [x] 2.3 リリース作成APIを実装する
  - Zodスキーマによるリクエストバリデーション
  - ID重複チェック（409エラー）
  - リリース名必須バリデーション（400エラー）
  - 正常時は201で作成結果を返却
  - _Requirements: 5.1, 5.2, 5.3, 12.1, 12.2, 12.3_

- [x] 2.4 リリース更新APIを実装する
  - 存在チェック（404エラー）
  - Zodスキーマによるバリデーション
  - 更新日時の自動更新
  - _Requirements: 6.1, 6.2, 12.1, 12.2, 12.3_

- [x] 2.5 リリース削除APIを実装する
  - 存在チェック（404エラー）
  - 関連ディスクもカスケード削除
  - _Requirements: 7.2, 12.1, 12.3_

- [x] 2.6 リリースルーターを管理画面に統合する
  - 管理者認証ミドルウェア適用
  - adminルーターへのマウント
  - _Requirements: 12.4_

- [x] 3. ディスクAPIエンドポイント実装
- [x] 3.1 (P) ディスク一覧取得APIを実装する
  - 親リリースの存在確認（404エラー）
  - ディスク番号順でソート
  - _Requirements: 13.1, 13.3_

- [x] 3.2 (P) ディスク作成APIを実装する
  - 親リリースの存在確認
  - Zodスキーマによるバリデーション（ディスク番号は正の整数）
  - 同一リリース内のディスク番号重複チェック（409エラー）
  - _Requirements: 9.2, 9.3, 9.4, 13.1, 13.2_

- [x] 3.3 (P) ディスク更新APIを実装する
  - 親リリースとディスクの存在確認
  - ディスク番号変更時の重複チェック
  - _Requirements: 10.2, 10.3, 13.1, 13.2_

- [x] 3.4 (P) ディスク削除APIを実装する
  - 親リリースとディスクの存在確認
  - _Requirements: 11.2, 13.1_

- [x] 4. フロントエンドAPIクライアント実装
- [x] 4.1 リリースAPIクライアントを実装する
  - Release, ReleaseWithDiscs型定義
  - list（ページネーション、検索、フィルタ対応）
  - get（詳細取得）
  - create, update, delete
  - 既存のeventsApiパターンに従う
  - _Requirements: 14.1, 14.2, 14.3_

- [x] 4.2 ディスクAPIクライアントを実装する
  - Disc型定義
  - list, create, update, delete（リリースIDを含むネストエンドポイント）
  - _Requirements: 14.1, 14.2, 14.3_

- [x] 5. リリース管理画面UI実装
- [x] 5.1 リリース一覧表示機能を実装する
  - TanStack Queryによるデータフェッチ
  - テーブル表示（ID、リリース名、カタログ番号、タイプ、発売日、ディスク数、作成日時、更新日時）
  - カラム表示切り替え機能（useColumnVisibility）
  - ページネーション（DataTablePagination）
  - デバウンス付き検索
  - リリースタイプフィルタ
  - ローディング状態とエラー表示
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

- [x] 5.2 リリース作成機能を実装する
  - 新規作成ダイアログ
  - フォーム入力（名前、日本語名、英語名、カタログ番号、発売日、タイプ、メモ）
  - バリデーションエラー表示
  - 作成成功時の一覧更新とメッセージ表示
  - _Requirements: 5.1, 5.2, 5.4, 5.5_

- [x] 5.3 リリース編集機能を実装する
  - 編集ダイアログ（リリース詳細取得）
  - フォーム入力と更新
  - 成功時のメッセージ表示
  - _Requirements: 6.1, 6.3_

- [x] 5.4 リリース削除機能を実装する
  - 削除確認ダイアログ（confirm）
  - 関連ディスクも削除される旨の警告
  - 成功時の一覧更新とメッセージ表示
  - エラー時のメッセージ表示
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [x] 5.5 ディスク一覧表示機能を実装する
  - リリース編集ダイアログ内に表示
  - ディスク番号順でソート
  - ディスク番号をBadgeで表示
  - ディスク名表示
  - _Requirements: 6.4, 8.1, 8.2, 8.3_

- [x] 5.6 ディスク作成機能を実装する
  - ディスク追加ダイアログ
  - ディスク番号と名前の入力
  - デフォルトで次のディスク番号を設定
  - 作成成功時のディスク一覧更新
  - _Requirements: 9.1, 9.5_

- [x] 5.7 ディスク編集機能を実装する
  - ディスク編集ダイアログ
  - ディスク番号と名前の更新
  - 成功時のディスク一覧更新
  - _Requirements: 10.1, 10.4_

- [x] 5.8 ディスク削除機能を実装する
  - 削除確認ダイアログ（confirm）
  - 成功時のディスク一覧更新
  - _Requirements: 11.1, 11.3_

- [x] 6. 管理画面ナビゲーション統合
- [x] 6.1 (P) リリース管理ルートを追加する
  - /admin/releasesルートファイル作成
  - 既存の管理画面レイアウト内に配置
  - _Requirements: 15.1, 15.2_

- [x] 6.2 (P) サイドバーにリリース管理リンクを追加する
  - 「リリース管理」グループを追加
  - Discアイコンを使用
  - リリース一覧へのリンク
  - _Requirements: 15.3_

- [x] 7. データベースマイグレーションとテスト
- [x] 7.1 スキーマをデータベースにプッシュする
  - make db-pushでスキーマ反映
  - テーブル作成確認
  - _Requirements: 1.1, 2.1, 3.1_

- [x] 7.2 動作確認テストを実施する
  - リリースCRUD操作の確認
  - ディスクCRUD操作の確認
  - カスケード削除の確認
  - ページネーション・検索・フィルタの確認
  - _Requirements: 1.1, 2.1, 4.1, 5.1, 6.1, 7.2, 8.1, 9.2, 10.2, 11.2, 12.1, 13.1_

