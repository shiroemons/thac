# Implementation Plan

## Task 1: データベーススキーマとバリデーション

- [ ] 1.1 マスタデータテーブルのスキーマを定義する
  - platforms、alias_types、credit_roles、official_work_categoriesの4テーブルを作成
  - 全テーブルでcodeをテキスト型主キーとして定義
  - platformsテーブルにname、category、url_pattern、タイムスタンプ（created_at、updated_at）を含める
  - alias_types、credit_roles、official_work_categoriesはタイムスタンプなしの簡易構造
  - platformsテーブルにcategoryカラムのインデックスを作成
  - 既存のauthスキーマと同じパターンでスキーマを構成し、packages/db/src/index.tsからエクスポート
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 6.1, 6.2_

- [ ] 1.2 (P) Zodバリデーションスキーマを作成する
  - 各マスタテーブルの作成・更新・取得用スキーマを定義
  - 空文字列を拒否し、空白をトリミングするバリデーションを実装
  - platformsのurl_patternに正規表現の有効性検証を追加
  - drizzle-zodを使用してDrizzleスキーマから型を生成
  - packages/db/src/index.tsからバリデーションスキーマをエクスポート
  - _Requirements: 1.5, 6.4, 6.5, 6.6_

- [ ] 1.3 マイグレーションを生成しスキーマを適用する
  - drizzle-kit generateでマイグレーションファイルを生成
  - drizzle-kit pushまたはmigrateでデータベースに反映
  - Drizzle Studioで4テーブルが作成されていることを確認
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ] 1.4 初期データを投入するシードスクリプトを作成する
  - alias_typesのデフォルト値（romanization: ローマ字表記、pseudonym: 別名義）を登録
  - official_work_categoriesのデフォルト値（pc98、windows、zun_collection、akyus_untouched_score、commercial_book、tasofro、other）を登録
  - 冪等性を確保し、既存データがあれば上書きまたはスキップする
  - _Requirements: 1.6, 1.7_

## Task 2: 管理者認証ミドルウェア

- [ ] 2.1 管理者APIへのアクセス制御ミドルウェアを実装する
  - Better-Authのセッションからユーザー情報を取得
  - 未認証リクエストに401ステータスを返却
  - 非管理者ユーザーに403ステータスを返却
  - 管理者ロールを持つユーザーのみ後続処理へ進行を許可
  - ミドルウェアでユーザー情報をHonoコンテキストに設定
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

## Task 3: マスタデータCRUD API

- [ ] 3.1 プラットフォームのCRUDエンドポイントを実装する
  - 一覧取得（ページネーション、カテゴリフィルタ対応）
  - 個別取得（codeによる検索）
  - 新規作成（Zodバリデーション、重複チェック）
  - 更新（codeは変更不可、部分更新対応）
  - 削除（ハードデリート）
  - バリデーションエラー時に400、未検出時に404、重複時に409を返却
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.8, 2.9, 6.3_

- [ ] 3.2 (P) 別名義種別のCRUDエンドポイントを実装する
  - 一覧取得、個別取得、新規作成、更新、削除の全操作を実装
  - プラットフォームと同じエラーハンドリングパターンを適用
  - _Requirements: 2.1, 2.7, 2.8, 2.9_

- [ ] 3.3 (P) クレジット役割のCRUDエンドポイントを実装する
  - 一覧取得、個別取得、新規作成、更新、削除の全操作を実装
  - プラットフォームと同じエラーハンドリングパターンを適用
  - _Requirements: 2.1, 2.7, 2.8, 2.9_

- [ ] 3.4 (P) 公式作品カテゴリのCRUDエンドポイントを実装する
  - 一覧取得、個別取得、新規作成、更新、削除の全操作を実装
  - プラットフォームと同じエラーハンドリングパターンを適用
  - _Requirements: 2.1, 2.7, 2.8, 2.9_

## Task 4: 一括インポートAPI

- [ ] 4.1 ファイルパース・バリデーションユーティリティを作成する
  - CSVファイルのパース機能を実装
  - JSONファイルのパース機能を実装
  - 全行をバリデーションし、エラー時は行番号とエラー内容を返却
  - _Requirements: 4.1, 4.2, 4.3_

- [ ] 4.2 インポートエンドポイントを実装する
  - 各マスタテーブルに対応するインポートエンドポイントを作成
  - トランザクションを使用してアトミックな操作を保証
  - Upsertモード（既存レコードは更新、新規は挿入）をサポート
  - インポート成功時に作成・更新件数のサマリーを返却
  - _Requirements: 4.4, 4.5, 4.6_

## Task 5: 管理画面ナビゲーション

- [ ] 5.1 管理ダッシュボードにマスタデータナビゲーションを追加する
  - AdminHeaderのナビゲーションリンク配列にマスタデータ項目を追加
  - 4種類のマスタテーブル（プラットフォーム、別名義種別、クレジット役割、公式作品カテゴリ）へのリンクを設置
  - マスタデータ管理セクションのルーティングを設定（/admin/master/配下）
  - _Requirements: 5.1, 5.2_

## Task 6: マスタデータ一覧表示

- [ ] 6.1 プラットフォーム一覧画面を実装する
  - TanStack Queryでデータをフェッチ
  - テーブル形式でデータを表示（code、name、category、url_pattern）
  - カテゴリによるフィルタリングを実装
  - ローディング中にインジケータを表示
  - APIエラー時にユーザーフレンドリーなメッセージを表示
  - _Requirements: 5.3, 5.8, 5.9_

- [ ] 6.2 (P) 別名義種別一覧画面を実装する
  - プラットフォームと同じパターンで一覧表示を実装
  - ローディング・エラー表示を含める
  - _Requirements: 5.3, 5.8, 5.9_

- [ ] 6.3 (P) クレジット役割一覧画面を実装する
  - プラットフォームと同じパターンで一覧表示を実装
  - ローディング・エラー表示を含める
  - _Requirements: 5.3, 5.8, 5.9_

- [ ] 6.4 (P) 公式作品カテゴリ一覧画面を実装する
  - プラットフォームと同じパターンで一覧表示を実装
  - ローディング・エラー表示を含める
  - _Requirements: 5.3, 5.8, 5.9_

## Task 7: フォームとCRUD操作

- [ ] 7.1 マスタデータ用フォームコンポーネントを作成する
  - 各マスタテーブルに対応した入力フォームを作成
  - 新規作成モードと編集モードの両方に対応
  - Zodスキーマによるクライアントサイドバリデーションを実装
  - 必須項目・オプション項目を明確に表示
  - _Requirements: 5.4, 5.5_

- [ ] 7.2 作成・編集・削除操作を実装する
  - 「新規作成」ボタンでフォームダイアログを表示
  - 「編集」ボタンで既存データを読み込んだフォームを表示
  - 「削除」ボタンで確認ダイアログを表示し、確認後に削除を実行
  - 操作成功時にトースト通知を表示
  - 操作中はローディングインジケータを表示
  - _Requirements: 5.4, 5.5, 5.6, 5.8, 5.9_

## Task 8: インポート機能UI

- [ ] 8.1 ファイルアップロードコンポーネントを作成する
  - CSV/JSONファイルを受け付けるファイル選択UIを作成
  - ドラッグ&ドロップによるファイル選択をサポート
  - ファイル形式の事前検証を実装
  - _Requirements: 5.7_

- [ ] 8.2 インポート処理と結果表示を実装する
  - ファイルアップロード後にAPIを呼び出し
  - インポート成功時に作成・更新件数を表示
  - バリデーションエラー時に行ごとのエラー詳細を表示
  - インポート処理中はプログレス表示
  - _Requirements: 5.7, 5.8, 5.9_

## Task 9: 統合とテスト

- [ ] 9.1 CRUD APIの統合テストを作成する
  - 認証ミドルウェアの401/403レスポンステスト
  - 各マスタテーブルのCRUD操作テスト
  - バリデーションエラーと重複エラーのテスト
  - _Requirements: 2.8, 2.9, 3.2, 3.3, 6.3_

- [ ] 9.2 (P) インポートAPIの統合テストを作成する
  - CSV/JSONパースのテスト
  - バリデーションエラー時の全体拒否テスト
  - トランザクションによるアトミック操作のテスト
  - Upsertモードの動作確認テスト
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

- [ ]* 9.3 (P) フロントエンドコンポーネントのユニットテストを作成する
  - フォームバリデーションのテスト
  - ローディング・エラー状態の表示テスト
  - ユーザーインタラクションのテスト
  - _Requirements: 5.4, 5.5, 5.8, 5.9_
