# Implementation Plan

## Task Overview

公式作品（official_works）と公式楽曲（official_songs）の管理機能を実装する。既存のマスタ管理パターンを踏襲し、データベーススキーマ、API、管理画面UI、TSVインポート機能を順次構築する。

---

## Tasks

- [x] 1. データベーススキーマの実装
- [x] 1.1 (P) 公式作品テーブルのスキーマを定義する
  - 作品情報（id、名前、カテゴリ、シリーズコード、発売日など）を格納するテーブルを作成
  - カテゴリマスタへの外部キー参照を設定
  - シリーズコードのユニーク制約（NULL許容）を追加
  - カテゴリ、発売日、表示順にインデックスを作成
  - 作成日時・更新日時の自動設定を構成
  - _Requirements: 1.1, 1.2, 1.3_

- [x] 1.2 (P) 公式楽曲テーブルのスキーマを定義する
  - 楽曲情報（id、名前、主題区分、作曲者名など）を格納するテーブルを作成
  - 作品への外部キー参照を設定（作品削除時は関連楽曲も連動削除）
  - 原曲への自己参照外部キーを設定（原曲削除時はNULLに設定）
  - 公式アレンジフラグのboolean型カラムを定義
  - 主題区分、原曲参照、作品参照にインデックスを作成
  - _Requirements: 2.1, 2.3_

- [x] 1.3 公式作品・楽曲のバリデーションスキーマを作成する
  - 作品・楽曲それぞれの登録・更新・取得用バリデーションルールを定義
  - 必須フィールドと任意フィールドの検証ルールを設定
  - 型定義をエクスポートしてAPI・フロントエンドで利用可能にする
  - パッケージのエントリポイントからスキーマをエクスポート
  - _Requirements: 1.4, 2.4_

- [x] 1.4 データベースマイグレーションを実行する
  - マイグレーションファイルを生成
  - スキーマをデータベースに適用
  - 作成されたテーブルを確認
  - _Requirements: 1.1, 2.1_

- [x] 2. 公式作品のCRUD APIを実装する
- [x] 2.1 公式作品の一覧取得・個別取得エンドポイントを実装する
  - ページネーション付き一覧取得機能を実装
  - 作品名での部分一致検索を実装
  - カテゴリによるフィルタリングを実装
  - 個別作品の取得機能を実装（存在しない場合は404エラー）
  - _Requirements: 3.1, 3.2_

- [x] 2.2 公式作品の作成・更新・削除エンドポイントを実装する
  - 新規作品登録機能を実装（バリデーション付き）
  - シリーズコード重複時のエラーハンドリングを実装
  - 作品更新機能を実装（idは変更不可）
  - 作品削除機能を実装（関連楽曲は連動削除）
  - 未認証アクセス時の401エラーを返す
  - _Requirements: 3.3, 3.4, 3.5, 3.6, 3.7_

- [x] 2.3 公式作品のインポート機能を実装する
  - TSVファイルを受け付けるエンドポイントを作成
  - 各行のバリデーション検証を実装
  - 既存データがある場合のUPSERT処理を実装
  - インポート結果（作成件数・更新件数・合計件数）を返す
  - バリデーションエラー時はエラー行と詳細を返す
  - _Requirements: 8.1, 8.3, 8.4, 8.5, 8.6, 8.7_

- [x] 3. 公式楽曲のCRUD APIを実装する
- [x] 3.1 公式楽曲の一覧取得・個別取得エンドポイントを実装する
  - ページネーション付き一覧取得機能を実装
  - 楽曲名での部分一致検索を実装
  - 作品によるフィルタリングを実装
  - 主題区分によるフィルタリングを実装
  - 個別楽曲の取得機能を実装（作品情報を含む）
  - _Requirements: 4.1, 4.2, 4.7_

- [x] 3.2 公式楽曲の作成・更新・削除エンドポイントを実装する
  - 新規楽曲登録機能を実装（バリデーション付き）
  - 原曲参照の自己参照バリデーションを実装（自身を原曲に指定不可）
  - 楽曲更新機能を実装（idは変更不可）
  - 楽曲削除機能を実装
  - 未認証アクセス時の401エラーを返す
  - _Requirements: 4.3, 4.4, 4.5, 4.6_

- [x] 3.3 公式楽曲のインポート機能を実装する
  - TSVファイルを受け付けるエンドポイントを作成
  - 各行のバリデーション検証を実装
  - 原曲参照の自己参照チェックを実装
  - 既存データがある場合のUPSERT処理を実装
  - インポート結果（作成件数・更新件数・合計件数）を返す
  - _Requirements: 8.2, 8.4, 8.5, 8.6, 8.7_

- [x] 4. APIルーティングの統合
- [x] 4.1 公式管理用ルーターを作成し管理者ルーターに統合する
  - 公式管理用の親ルーターを作成
  - 作品・楽曲のルーターをマウント
  - 管理者ルーター配下に統合
  - 認証ミドルウェアが適用されていることを確認
  - _Requirements: 3.6, 4.6_

- [x] 5. フロントエンドAPIクライアントの実装
- [x] 5.1 (P) 公式作品用のAPIクライアント関数を追加する
  - 公式作品の型定義を追加
  - 一覧取得・個別取得・作成・更新・削除の関数を実装
  - ページネーション、検索、カテゴリフィルタのパラメータをサポート
  - インポート用のAPIクライアント関数を追加
  - _Requirements: 5.2_

- [x] 5.2 (P) 公式楽曲用のAPIクライアント関数を追加する
  - 公式楽曲の型定義を追加
  - 一覧取得・個別取得・作成・更新・削除の関数を実装
  - ページネーション、検索、作品フィルタ、主題区分フィルタのパラメータをサポート
  - インポート用のAPIクライアント関数を追加
  - _Requirements: 6.2_

- [x] 6. 公式作品の管理画面UIを実装する
- [x] 6.1 公式作品一覧ページを作成する
  - 公式作品一覧ページのルートを作成
  - 既存のテーブル、ページネーション、アクションバーコンポーネントを使用
  - 作品名での部分一致検索機能を実装
  - カテゴリによるフィルタリング機能を実装
  - 10/20/50件のページサイズ切り替えを実装
  - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.8_

- [x] 6.2 公式作品の作成・編集・削除機能を実装する
  - 新規作成ダイアログで全フィールドの入力フォームを実装
  - 行クリックで編集ダイアログを表示する機能を実装
  - 削除ボタンクリックで確認後に削除を実行する機能を実装
  - エラー時のメッセージ表示を実装
  - _Requirements: 5.5, 5.6, 5.7_

- [x] 6.3 公式作品のインポート機能をUIに追加する
  - インポートボタンとインポートダイアログを追加
  - TSVファイルのアップロード機能を実装
  - インポート結果（件数、エラー）の表示を実装
  - _Requirements: 8.8_

- [x] 7. 公式楽曲の管理画面UIを実装する
- [x] 7.1 公式楽曲一覧ページを作成する
  - 公式楽曲一覧ページのルートを作成
  - 既存のテーブル、ページネーション、アクションバーコンポーネントを使用
  - 楽曲名での部分一致検索機能を実装
  - 作品によるフィルタリング機能を実装
  - 主題区分によるフィルタリング機能を実装
  - 10/20/50件のページサイズ切り替えを実装
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5, 6.8_

- [x] 7.2 公式楽曲の作成・編集・削除機能を実装する
  - 新規作成ダイアログで全フィールドの入力フォームを実装
  - 作品選択用のセレクトボックスを実装
  - 公式アレンジ楽曲登録時に原曲を選択できるセレクトボックスを実装
  - 行クリックで編集ダイアログを表示する機能を実装
  - 削除ボタンクリックで確認後に削除を実行する機能を実装
  - _Requirements: 6.6, 6.7_

- [x] 7.3 公式楽曲のインポート機能をUIに追加する
  - インポートボタンとインポートダイアログを追加
  - TSVファイルのアップロード機能を実装
  - インポート結果（件数、エラー）の表示を実装
  - _Requirements: 8.8_

- [x] 8. ナビゲーションの統合
- [x] 8.1 サイドバーに「公式管理」グループを追加する
  - ナビゲーション設定に「公式管理」グループを追加
  - 公式作品メニュー項目を追加
  - 公式楽曲メニュー項目を追加
  - 適切なアイコンを設定
  - 現在のページに応じたアクティブ状態を表示
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [x] 9. ダッシュボード統合
- [x] 9.1 統計APIを拡張して公式作品・楽曲の件数を返す
  - 統計APIに公式作品・楽曲のカウントクエリを追加
  - 統計データ型に公式作品・楽曲フィールドを追加
  - 並列でカウントを取得するよう実装
  - _Requirements: 9.4_

- [x] 9.2 ダッシュボードに公式作品・楽曲の統計カードを追加する
  - 公式作品の総件数を表示するカードを追加
  - 公式楽曲の総件数を表示するカードを追加
  - カードクリックで対応する一覧ページに遷移
  - _Requirements: 9.1, 9.2, 9.3_

- [x] 10. 動作確認とビルド検証
- [x] 10.1 型チェックとリントを実行する
  - 型チェックでエラーがないことを確認
  - リントチェックでエラーがないことを確認
  - 必要に応じてエラーを修正
  - _Requirements: 1.1, 2.1_

- [x] 10.2 全体の動作確認を行う
  - 開発サーバーを起動して各機能をブラウザで確認
  - 公式作品のCRUD操作が正常に動作することを確認
  - 公式楽曲のCRUD操作が正常に動作することを確認
  - TSVインポートが正常に動作することを確認
  - ナビゲーションとダッシュボードが正常に表示されることを確認
  - _Requirements: 5.1, 6.1, 7.1, 8.8, 9.1_

---

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1, 1.2, 1.3 | 1.1, 1.4 |
| 1.4 | 1.3 |
| 2.1, 2.3 | 1.2, 1.4 |
| 2.2 | 3.2 |
| 2.4 | 1.3 |
| 3.1, 3.2 | 2.1 |
| 3.3, 3.4, 3.5, 3.6, 3.7 | 2.2 |
| 4.1, 4.2, 4.7 | 3.1 |
| 4.3, 4.4, 4.5, 4.6 | 3.2 |
| 5.1, 5.2, 5.3, 5.4, 5.8 | 6.1 |
| 5.5, 5.6, 5.7 | 6.2 |
| 6.1, 6.2, 6.3, 6.4, 6.5, 6.8 | 7.1 |
| 6.6, 6.7 | 7.2 |
| 7.1, 7.2, 7.3, 7.4 | 8.1 |
| 8.1, 8.3, 8.4, 8.5, 8.6, 8.7 | 2.3 |
| 8.2, 8.4, 8.5, 8.6, 8.7 | 3.3 |
| 8.8 | 6.3, 7.3 |
| 9.1, 9.2, 9.3 | 9.2 |
| 9.4 | 9.1 |
