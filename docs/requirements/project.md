# 東方編曲録 要求仕様書

> Version 1.0

## 目次

- [1. 文書の目的とゴール](#1-文書の目的とゴール)
  - [1.1 目的](#11-目的)
  - [1.2 プロダクトの価値](#12-プロダクトの価値)
- [2. 定義・前提](#2-定義前提)
  - [2.1 トラック同一性](#21-トラック同一性)
  - [2.2 入力の現実](#22-入力の現実必須任意)
- [3. スコープ](#3-スコープ)
  - [3.1 実装対象](#31-実装対象)
  - [3.2 明示的にやらないこと](#32-明示的にやらないこと)
- [4. 画面方針](#4-画面方針)
- [5. 管理対象データ](#5-管理対象データ)
- [6. Public（閲覧）機能要件](#6-public閲覧機能要件)
  - [FR-01〜FR-04 検索](#fr-01-グローバルナビヘッダー)
  - [FR-05〜FR-11 公式作品/公式曲](#fr-05fr-11-公式作品公式曲)
  - [FR-12〜FR-16 サークル](#fr-12fr-16-サークル)
  - [FR-17〜FR-21 イベント](#fr-17fr-21-イベント)
  - [FR-22〜FR-26 リリース](#fr-22fr-26-リリース)
  - [FR-27〜FR-33 トラック](#fr-27fr-33-トラック)
  - [FR-34〜FR-37 アーティスト/役割](#fr-34fr-37-アーティスト役割)
  - [FR-38〜FR-40 統計](#fr-38fr-40-統計)
- [7. Admin（管理）機能要件](#7-admin管理機能要件)
  - [FR-41〜FR-42 ログイン/ダッシュボード](#fr-41-管理ログイン)
  - [FR-43〜FR-63 入力（CRUD）](#fr-43fr-63-入力crud対象)
  - [FR-64〜FR-67 履歴・削除](#fr-64fr-67-履歴削除)
- [8. 権限・編集フロー](#8-権限編集フロー)
- [9. 検索](#9-検索)
- [10. 非機能要件](#10-非機能要件)
- [11. 未決定事項](#11-未決定事項)
  - [11.1 権限](#111-権限)
  - [11.2 派生 relationship_type](#112-派生-relationship_type)
  - [11.3 検索仕様](#113-検索仕様)
  - [11.4 統計/ランキング](#114-統計ランキング)
  - [11.5 将来拡張](#115-将来拡張)
  - [11.6 検索UI](#116-検索ui)

---

## 1. 文書の目的とゴール

### 1.1 目的

* 既存「東方編曲録」から移行可能な形で、閲覧体験（探索導線）と、データ登録・保守に必要な管理機能を新実装で再構築する。
* 仕様を固定し、DB設計・API設計・画面設計・実装を一貫して進められる状態にする。
* 将来拡張（閲覧者ログイン、検索エンジン導入等）を前提に、今の段階で「将来に耐える要求」を明文化する。

### 1.2 プロダクトの価値

閲覧者の最重要ユースケース：

1. **検索、詳細検索でアレンジを探す**
2. **原曲からアレンジを探す**
3. **サークルからアルバム（リリース）、アレンジを探す**
4. **アーティスト、役割別からアレンジを探す**
5. **イベントから探す**
6. **配信先を見つける**
7. **統計情報を見る**（サークルごと、アーティストごと、イベントごと等）

---

## 2. 定義・前提

### 2.1 トラック同一性

**再録・別ミックス・リマスター・動画版は、別トラック**として扱う。

「同じ曲」と思えるものでも、音源・媒体・編集差があるものは別レコードとする。

### 2.2 入力の現実（必須/任意）

原曲対応の区間秒（start/end）やテンポ（μs）は「入力できる人がやる」。**必須ではない**（空でも成立する）。

**その他の任意入力項目:**
* ISRC
* JANコード
* BPM
* 歌詞
* 配信先情報（Spotify、BOOTH等の音楽配信サービスURL、委託先URL）

---

## 3. スコープ

### 3.1 実装対象

* **Public（閲覧）**：40機能
* **Admin（管理）**：27機能

### 3.2 明示的にやらないこと

* YouTube/Spotify等の **外部サービスからのインポートは行わない**
* 画像・メディア資産（ジャケット画像等）は **現状取り扱わない**（将来可能性あり）
* 閲覧者ログイン（お気に入り等）は **将来やりたい（Yes）**が、現行フェーズの必須ではない

---

## 4. 画面方針

### 4.1 グローバル検索の入口

ユーザーが検索モードを選択可能：

* **トラック検索**：トラック（曲）のみを対象
* **総合検索**：トラック・サークル・アーティスト・原曲を横断、カテゴリ別に結果を表示

### 4.2 詳細検索の結果単位

* **詳細検索の結果は「トラック固定」**（1行=1トラック）。

### 4.3 原曲ページの見せ方

* 公式曲→アレンジは **トラック一覧を主**とする。

### 4.4 サークル/イベント詳細の中心

* サークル詳細は **リリース中心**。ただし **曲一覧タブも標準で提供**。
* イベント回詳細は **リリース中心**。ただし **曲一覧タブも閲覧可能**。

### 4.5 リリース詳細の配信リンク

* リリース詳細の配信リンクは **上部に集約**。

### 4.6 役割ページの導線

* **役割 → アーティスト一覧 → トラック一覧** の導線。

### 4.7 トラック詳細のブロック順

1. 曲名＋所属リリース
2. 原曲（公式曲）
3. クレジット（役割別）
4. 配信リンク
5. 別バージョン（派生）
6. メタ（任意：ISRC/BPM/区間秒等）

---

## 5. 管理対象データ

### 5.1 主要エンティティ

* 公式作品（カテゴリ配下）
* 公式曲（原曲/公式アレンジ、登場作品、キャラクタ対応）
* サークル（外部リンク含む）
* アーティスト（個人/ユニット）＋別名義（ローマ字表記・別名義）
* イベント（シリーズ、イベント回、開催日）
* リリース（頒布/公開単位：アルバム/シングル/動画公開等）
* ディスク（任意）
* トラック（曲）
* トラッククレジット（盤面表記→人物/別名義）＋役割（vocal/arrange/lyric等、複数可）
* トラック↔公式曲対応（複数原曲・順序・任意で区間秒/確度）
* トラック派生（別版関係：relationship_type + notes）
* 公開/配信リンク（リリース単位/トラック単位）
* コード類（JAN/ISRC）
* 解析メタ（テンポ変化等：任意）

### 5.2 運用ルール

* 公式曲・サークル・アーティスト等には **表記揺れがある前提**で、検索や別名義で吸収する。
* 配信リンクは「存在すれば価値」。公式/非公式の区別は持つが、閲覧側の「配信有無」は単純に存在で判定する。
* 任意入力項目（区間秒/BPM等）は空でも成立する。

---

## 6. Public（閲覧）機能要件

---

### FR-01 グローバルナビ/ヘッダー

**目的**：全ページ共通の入口を提供し、主目的であるトラック探索に最短で入れる。
**要件**

* グローバル検索窓（検索モード選択可能）
  * トラック検索：トラック（曲）のみを対象
  * 総合検索：トラック・サークル・アーティスト・原曲を横断
* 主要導線：検索／原曲／サークル／イベント／統計
* 検索窓からは「詳細検索（FR-03）」へ遷移可能（条件引き継ぎ）

---

### FR-02 クイック検索

**目的**：入力途中でも候補提示し、目的ページに直行できる。
**要件**

* トラック名の部分一致/前方一致の候補提示（初期は簡易で可）
* 候補のクリックでトラック詳細へ遷移
* 検索クエリ言語（FR-04）による検索をサポート
* 将来：検索エンジン導入時にサジェスト高度化

---

### FR-03 詳細検索

**目的**：閲覧者が「原曲/サークル/イベント/人/配信」など複数条件でトラックを絞り込める。
**検索結果の単位**：1行=1トラック（固定）

#### 3.1 一覧列（固定）

1. サークル
2. 曲名（トラック）
3. リリース名
4. ボーカル
5. 編曲
6. 作詞
7. 原曲（公式曲）
8. イベント回
9. 頒布日（release_date）
10. 配信有無（boolean）

#### 3.2 表示ルール（多値・欠損：確定）

* ボーカル/編曲/作詞：**複数なら全件表示（省略しない）**
* 原曲：**複数なら全件表示（省略しない）**
* イベント：基本は **リリースに紐づくイベント回**。未設定は空。
* 配信有無：`release_publications` または `track_publications` が **1件でもあれば「あり」**。

#### 3.3 フィルタ（必須）

* キーワード（曲名・リリース名・サークル名・クレジット表記・原曲名）
* 原曲（公式曲）

  * **複数選択：デフォルトAND（全て含む）**
* 原曲の数（例：1曲 / 2曲以上）
* サークル
* イベント回
* 役割者（人物で指定：ボーカル/編曲/作詞）
* 頒布日範囲
* 配信ありのみ
* 派生タイプ（relationship_type）
* ボーカル有無

#### 3.4 ソート（必須）

* デフォルト：頒布日（release_date）降順
* タイブレーク：リリース名 → disc番号（あれば）→ トラック番号
* 将来候補：曲名昇順／サークル名昇順
* **ソート方法を選択できるUI**を提供

#### 3.5 リリース（アルバム）詳細検索時の特例

* アルバム内の一覧/絞り込みは、discがあれば **disc→track順**を優先

---

### FR-04 検索クエリ言語

**目的**：ユーザーが検索条件を明示的に制御し、精度・再現性を上げる。
**要件（確定）**

* AND/OR/NOT を指定可能
* デフォルト結合は **AND**
* フィールド指定 `field:value` をサポート（例：`artist:senya`）
* 将来Meilisearch等に移植可能な形（AST等の中間表現を想定）

**推奨フィールド（現行仕様として採用）**

* `track:` トラック名
* `release:` リリース名
* `circle:` サークル名
* `artist:` アーティスト名（正規化人物）
* `credit:` 盤面表記（credit_name）
* `original:` 原曲（公式曲）
* `event:` イベント回
* `type:` 派生タイプ（relationship_type）
* 将来：`has:vocal` `has:streaming` 等

---

### FR-05〜FR-11 公式作品/公式曲

**目的**：「原曲から探す」体験を成立させる。

#### FR-05 公式作品一覧

* カテゴリ別（PC-98/Windows/ZUN’s…）に閲覧できる

#### FR-06 公式作品詳細

* 作品情報（名称、発売日等）
* 収録公式曲一覧（登場文脈があれば併記）

#### FR-07 公式曲一覧

* 一覧/検索/絞り込み（最低限のカテゴリ/作品起点）

#### FR-08 公式曲詳細

* 公式曲情報（日本語/英語名等）
* 登場作品と文脈（Stage等）
* キャラクタとの対応（ある場合）

#### FR-09 公式曲→アレンジ一覧

* アレンジは **トラック一覧中心**
* 並び：頒布日降順（新しい順）
* 併用フィルタ：サークル、配信ありのみ、役割条件、派生タイプ（将来でも可）

#### FR-10/FR-11 関連ナビ

* 作品→曲、曲→作品への往復導線

---

### FR-12〜FR-16 サークル

**目的**：「サークルの新譜を追う」体験を成立させる。

#### FR-12 サークル一覧

* 頭文字索引で辿れる（latin/かな/漢字/記号など）

#### FR-13 サークル検索

* 名称検索（表記揺れ前提）

#### FR-14 サークル詳細

* サークル基本情報
* 外部リンク（公式サイト、BOOTH、X、YouTube等）
* **リリース中心**
* **曲一覧タブを標準提供**

#### FR-15 サークル詳細：リリース一覧

* 頒布日降順
* リリース種別で絞り込み（将来でも可）

#### FR-16 サークル詳細：曲一覧タブ

* リリース跨ぎでトラック一覧
* 検索結果列はFR-03に近い形（少なくとも曲名/リリース/頒布日/配信）

---

### FR-17〜FR-21 イベント

**目的**：「イベントから新譜を追う」体験を成立させる。

#### FR-17 イベントシリーズ一覧

* 例：コミックマーケット、例大祭等

#### FR-18 イベント回一覧

* 回次、開催日、会場等の一覧

#### FR-19 イベント回詳細

* **リリース一覧が中心**
* （将来/同時）曲一覧タブを閲覧可能

#### FR-20 イベント回詳細：曲一覧タブ

* イベント回に紐づくリリースのトラックを俯瞰表示

#### FR-21 イベント検索

* 回次/年/月/会場などで絞れる（最低限は回次・年で可）

---

### FR-22〜FR-26 リリース

**目的**：「新譜」「配信先」「収録曲」を最短で見せる。

#### FR-22 リリース一覧

* 新着（頒布日降順）
* 種別フィルタ（album/single/video…）は将来でも可

#### FR-23 リリース検索

* 名称、カタ番で検索

#### FR-24 リリース詳細

* リリース情報（名称、頒布日、イベント回、カタ番、種別）
* 関与サークル（役割・順序）

#### FR-25 リリース詳細：収録曲

* discがあれば disc→track順
* discが無ければ track順

#### FR-26 リリース詳細：配信リンク

* 代表リンクを目立たせる
* 国、公開状態、公開日時等は表示可能（初期はURLとプラットフォーム名でも可）

---

### FR-27〜FR-33 トラック

**目的**：曲の最終詳細。原曲・クレジット・配信を統合して見せる。

#### FR-27 トラック一覧

* 全体一覧（最初は必須でなくても可、検索が主）

#### FR-28 トラック検索

* FR-02/FR-03で満たす

#### FR-29 トラック詳細

ブロック順は「4.7 トラック詳細のブロック順」に準拠。

#### FR-30 トラック配信リンク

* track_publications を表示
* 無ければ release_publications に誘導

#### FR-31 トラック原曲対応

* 複数原曲対応
* 順序（part_position）
* 任意：区間秒、確度、備考

#### FR-32 トラック派生

* relationship_type + notes で管理された関連トラックを表示
* UIの最終形は未確定（ただし表示できることは要件）

#### FR-33 トラッククレジット

* 盤面表記（credit_name）を第一に表示
* 人物（artist）/別名義（artist_alias）へリンク
* 役割（vocal/arrange/lyric等）を役割別に表示
* 順序（credit_position/role_position）を尊重

---

### FR-34〜FR-37 アーティスト/役割

**目的**：「歌っている人」「編曲者」から辿る導線を成立させる。

#### FR-34 アーティスト一覧

* 索引・検索で辿れる

#### FR-35 アーティスト詳細

* 参加トラック一覧（役割横断）
* 別名義一覧（ローマ字/別名義）

#### FR-36 役割一覧

* 役割（vocalist/arranger/lyricist…）を入口にする

#### FR-37 役割→アーティスト→トラック一覧

* **役割 → アーティスト一覧 → トラック一覧** の導線

---

### FR-38〜FR-40 統計

**目的**：運用の可視化、閲覧の発見性向上。

#### FR-38 統計ダッシュボード

* 登録数など

#### FR-39 ランキング

* 原曲別/役割者別等
* 具体的な指標・集計定義は未確定

#### FR-40 最近更新

* 最近追加/最近更新

---

## 7. Admin（管理）機能要件

### FR-41 管理ログイン

* Publicとは別のログイン導線
* 管理者/編集者を分けたい（RBACは未確定事項にて後述）

### FR-42 管理ダッシュボード

* 最低限：最近編集、最近追加、警告（未入力の必須情報など）
* 将来：申請（編集権限）未処理件数など

---

### FR-43〜FR-63 入力（CRUD）対象

以下は全て **作成/編集/削除（論理削除）/復元**の運用を想定。

#### FR-43 公式作品 CRUD

* カテゴリ、名称、発売日、備考等

#### FR-44 公式曲 CRUD

* 元曲/公式アレンジの関係
* 登場作品/文脈
* キャラクタ対応（将来でも可）

#### FR-45 サークル CRUD

#### FR-46 サークル外部リンク CRUD

* platforms に紐づくURL
* 公式/代表フラグ等

#### FR-47 イベントシリーズ CRUD

#### FR-48 イベント回 CRUD

#### FR-49 イベント日 CRUD

* 日別（1日目/2日目等）管理（最初は最小実装でも可）

#### FR-50 リリース CRUD

* 頒布日、イベント回、カタ番、種別、備考

#### FR-51 ディスク CRUD

* DISC1等

#### FR-52 リリース関与サークル CRUD

* role、position

#### FR-53 トラック CRUD

* disc任意、番号、名称

#### FR-54 トラッククレジット CRUD

* credit_name（盤面表記）
* artist、artist_alias の対応
* 順序

#### FR-55 クレジット役割付与 CRUD

* 1クレジットに複数役割付与（role_position）

#### FR-56 トラック↔公式曲対応 CRUD

* 複数原曲、順序
* 任意：区間秒、確度

#### FR-57 トラック派生 CRUD

* relationship_type（採用方針：追加推奨度高）
* 親子、notes

#### FR-58 リリース配信リンク CRUD

#### FR-59 トラック配信リンク CRUD

* platform、URL、公式/非公式、公開状態、国、代表リンク等

#### FR-60 JANコード CRUD

#### FR-61 ISRC CRUD

#### FR-62 テンポ/解析メタ CRUD

#### FR-63 マスタ CRUD

* platforms / credit_roles / alias_types / 公式カテゴリ等

---

### FR-64〜FR-67 履歴・削除

#### FR-64 監査ログ記録

* create/update/delete/restore を記録
* 誰が、いつ、何を、どの程度変更したか

#### FR-65 監査ログ閲覧

* レコード別に履歴を追える

#### FR-66 論理削除

* Publicからは基本的に非表示
* Adminでは復元可能

#### FR-67 削除済み表示

* 削除済み一覧、復元導線

---

## 8. 権限・編集フロー

### 8.1 RBAC

* Admin / Editor のロールを用意（Better Auth の admin プラグインで実現可能）
  * `createAccessControl` でカスタムロール・権限を定義
  * サーバー側・クライアント側両方で権限チェック可能
* 一般ユーザーとは別のログイン導線を提供

### 8.2 サークル限定編集権限

* 特定ユーザーに対し「特定サークルのみ編集可」を付与したい

### 8.3 編集申請フロー

* 編集者が「このサークルを編集したい」と申請し、管理者が承認/却下できるようにしたい

> ただし、RBACの「機能単位の可否表」は未確定（決定事項に回す）

---

## 9. 検索

### 9.1 検索実装方針

* 初期はDB検索でもよいが、検索仕様は将来エンジンに移しても意味が変わらないこと
* AND/OR/NOT、field:value を維持する
* 曖昧検索あり・詳細検索もあり（ただし具体仕様は未確定）

### 9.2 検索対象フィールド

* track.name（日本語/英語）
* release.name
* circle.name
* credit_name（盤面表記）
* artist.name / artist_alias.name
* official_song.name
* event.name

---

## 10. 非機能要件

### 10.1 可用性・保守性

* データが増えても検索一覧（FR-03）が破綻しない（1行=1トラック）
* 監査ログ/論理削除により、誤編集・誤削除から復旧できる

### 10.2 性能

* FR-03（詳細検索）は体感で遅くならないこと（将来検索エンジン導入で解決可能な設計にする）
* Public詳細（トラック/リリース/サークル/原曲）はキャッシュやクエリ最適化が可能な構造

### 10.3 SEO/共有

* PublicページはURLが安定している（共有しやすい）
* タイトル/メタ情報が最低限出る（将来）

---

## 11. 未決定事項

### 11.1 権限

**決定済み:**
* Better Auth の admin プラグインで RBAC を実現
* 基本ロール: Admin / Editor / User
* カスタム権限定義が可能（createAccessControl）

**未決定:**
1. 権限表の詳細（機能×ロールのマトリクス）
   * 例：公式曲編集可否、リリース削除可否、監査ログ閲覧可否、復元可否など
2. サークル限定編集の権限モデル（割当単位、継承、期限）
3. 編集申請フロー（申請項目、承認手順、通知）

### 11.2 派生 relationship_type

4. **relationship_type の列挙値**（再録/リマスター/動画版/別ミックス/…）
5. **トラック詳細での派生表示UI**（リスト/グルーピング/親子の見せ方）

### 11.3 検索仕様

**決定済み:**
* 検索クエリ言語: AND/OR/NOT、field:value をサポート（FR-04）
* デフォルト結合は AND
* 推奨フィールド: track:, release:, circle:, artist:, credit:, original:, event:, type:

**未決定:**
6. 曖昧検索の定義（表記揺れ、同義語、かなカナ、英字大小、記号）
7. 全文検索の範囲（notesを含めるか）
8. クエリ言語の拡張文法（括弧、フレーズ検索、エスケープ）

### 11.4 統計/ランキング

**未決定:**
9. ランキング指標の定義
   * 対象: 原曲別、サークル別、アーティスト別、イベント別
   * 指標候補: 登録数、被参照数、最近増加数
10. 最近更新の定義（更新対象テーブルの範囲）
11. 統計ダッシュボードの表示項目

### 11.5 将来拡張

**未決定:**
12. 閲覧者ログインでやる機能の範囲（お気に入り：対象はトラック/リリース/原曲/サークル？ 通知は？）
13. 画像・メディア資産の扱い（保持場所、権利表記、サイズ、表示箇所）

### 11.6 検索UI

**未決定:**
14. 総合検索の結果表示形式（カテゴリ別タブ/統合リスト/その他）
15. 検索モード切替のUI配置（ヘッダー内/検索画面内）

