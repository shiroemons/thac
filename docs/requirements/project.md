# プロジェクト全体の要求仕様書

# 東方編曲録 要求仕様書（完全版 v1.0）

## 0. 文書の目的とゴール

### 0.1 目的

* 既存「東方編曲録」から移行可能な形で、閲覧体験（探索導線）と、データ登録・保守に必要な管理機能を新実装で再構築する。
* 仕様を固定し、DB設計・API設計・画面設計・実装を一貫して進められる状態にする。
* 将来拡張（閲覧者ログイン、検索エンジン導入等）を前提に、今の段階で「将来に耐える要求」を明文化する。

### 0.2 プロダクトの価値（閲覧者が一番やりたいこと）

閲覧者の最重要ユースケース（優先順位高い順）：

1. **原曲（公式曲）からアレンジを探す**
2. **サークルの新譜（リリース）を追う**
3. **配信先（聴ける/買える場所）を見つける**
4. （追加）**イベントから探す**（イベント回→新譜→曲）

### 0.3 トラック同一性（定義）

* **再録・別ミックス・リマスター・動画版は、別トラック**として扱う。
  つまり「同じ曲」と思えるものでも、音源・媒体・編集差があるものは別レコードとする。

### 0.4 入力の現実（必須/任意）

* 原曲対応の区間秒（start/end）やテンポ（μs）は「入力できる人がやる」。
  **必須ではない**（空でも成立する）。

---

## 1. スコープ

### 1.1 実装対象（あなたの指定）

* **Public（閲覧）：1–37, 42–44**
* **Admin（管理）：51, 52, 58–82**

本書では、上記番号を「機能一覧のID」として扱い、各機能の要件を明記する。

### 1.2 明示的に「やらない」こと（現行仕様）

* YouTube/Spotify等の **外部サービスからのインポートは行わない**
* 画像・メディア資産（ジャケット画像等）は **現状取り扱わない**（将来可能性あり）
* 閲覧者ログイン（お気に入り等）は **将来やりたい（Yes）**が、現行フェーズの必須ではない

---

## 2. 画面方針（設計前提：確定事項）

### 2.1 グローバル検索の入口

* **ヘッダーの検索は「トラック検索」**を主目的とする。

### 2.2 詳細検索の結果単位

* **詳細検索の結果は「トラック固定」**（1行=1トラック）。

### 2.3 原曲（公式曲）ページの見せ方

* 公式曲→アレンジは **トラック一覧を主**とする。

### 2.4 サークル/イベント詳細の中心

* サークル詳細は **リリース中心**。ただし **曲一覧タブも標準で提供**。
* イベント回詳細は **リリース中心**。ただし **曲一覧タブも閲覧可能**。

### 2.5 リリース詳細の配信リンク

* リリース詳細の配信リンクは **上部に集約**。

### 2.6 役割ページの導線

* **役割 → アーティスト一覧 → トラック一覧** の導線。

### 2.7 トラック詳細のブロック順（確定）

1. 曲名＋所属リリース
2. 原曲（公式曲）
3. クレジット（役割別）
4. 配信リンク
5. 別バージョン（派生）
6. メタ（任意：ISRC/BPM/区間秒等）

---

## 3. 管理対象データ（概念モデル）

### 3.1 主要エンティティ

* 公式作品（カテゴリ配下）
* 公式曲（原曲/公式アレンジ、登場作品、キャラクタ対応）
* サークル（外部リンク含む）
* アーティスト（個人/ユニット）＋別名義（ローマ字表記・別名義）
* イベント（シリーズ、イベント回、開催日）
* リリース（頒布/公開単位：アルバム/シングル/動画公開等）
* ディスク（任意）
* トラック（曲）
* トラッククレジット（盤面表記→人物/別名義）＋役割（vocal/arrange/lyric等、複数可）
* トラック↔公式曲対応（複数原曲・順序・任意で区間秒/確度）
* トラック派生（別版関係：relationship_type + notes）
* 公開/配信リンク（リリース単位/トラック単位）
* コード類（JAN/ISRC）
* 解析メタ（テンポ変化等：任意）

### 3.2 不変の運用ルール（要求）

* 公式曲・サークル・アーティスト等には **表記揺れがある前提**で、検索や別名義で吸収する。
* 配信リンクは「存在すれば価値」。公式/非公式の区別は持つが、閲覧側の「配信有無」は単純に存在で判定する。
* 任意入力項目（区間秒/BPM等）は空でも成立する。

---

## 4. Public（閲覧）機能要件（1–37, 42–44）

> 注：番号IDはあなたの指定スコープ（1–37, 42–44）に合わせて列挙し、各機能の目的・表示・導線を明記します。

---

### #1 グローバルナビ/ヘッダー（P-00）

**目的**：全ページ共通の入口を提供し、主目的であるトラック探索に最短で入れる。
**要件**

* グローバル検索窓（トラック検索入口）
* 主要導線：検索／原曲／サークル／イベント／統計
* 検索窓からは「詳細検索（P-11）」へ遷移可能（条件引き継ぎ）

---

### #2 クイック検索（ヘッダー検索）

**目的**：入力途中でも候補提示し、目的ページに直行できる。
**要件**

* トラック名の部分一致/前方一致の候補提示（初期は簡易で可）
* 候補のクリックでトラック詳細へ遷移
* 将来：検索エンジン導入時にサジェスト高度化

---

### #3 詳細検索（P-11：検索結果はトラック固定）

**目的**：閲覧者が「原曲/サークル/イベント/人/配信」など複数条件でトラックを絞り込める。
**検索結果の単位**：1行=1トラック（固定）

#### 3.1 一覧列（固定）

1. サークル
2. 曲名（トラック）
3. リリース名
4. ボーカル
5. 編曲
6. 作詞
7. 原曲（公式曲）
8. イベント回
9. 頒布日（release_date）
10. 配信有無（boolean）

#### 3.2 表示ルール（多値・欠損：確定）

* ボーカル/編曲/作詞：**複数なら全件表示（省略しない）**
* 原曲：**複数なら全件表示（省略しない）**
* イベント：基本は **リリースに紐づくイベント回**。未設定は空。
* 配信有無：`release_publications` または `track_publications` が **1件でもあれば「あり」**。

#### 3.3 フィルタ（必須）

* キーワード（曲名・リリース名・サークル名・クレジット表記・原曲名）
* 原曲（公式曲）

  * **複数選択：デフォルトAND（全て含む）**
* 原曲の数（例：1曲 / 2曲以上）
* サークル
* イベント回
* 役割者（人物で指定：ボーカル/編曲/作詞）
* 頒布日範囲
* 配信ありのみ
* 派生タイプ（relationship_type）
* ボーカル有無

#### 3.4 ソート（必須）

* デフォルト：頒布日（release_date）降順
* タイブレーク：リリース名 → disc番号（あれば）→ トラック番号
* 将来候補：曲名昇順／サークル名昇順
* **ソート方法を選択できるUI**を提供

#### 3.5 リリース（アルバム）詳細検索時の特例

* アルバム内の一覧/絞り込みは、discがあれば **disc→track順**を優先

---

### #4 検索クエリ言語（キーワード高度化）

**目的**：ユーザーが検索条件を明示的に制御し、精度・再現性を上げる。
**要件（確定）**

* AND/OR/NOT を指定可能
* デフォルト結合は **AND**
* フィールド指定 `field:value` をサポート（例：`artist:senya`）
* 将来Meilisearch等に移植可能な形（AST等の中間表現を想定）

**推奨フィールド（現行仕様として採用）**

* `track:` トラック名
* `release:` リリース名
* `circle:` サークル名
* `artist:` アーティスト名（正規化人物）
* `credit:` 盤面表記（credit_name）
* `original:` 原曲（公式曲）
* `event:` イベント回
* `type:` 派生タイプ（relationship_type）
* 将来：`has:vocal` `has:streaming` 等

---

### #5–#11 公式作品/公式曲（P2系）

**目的**：「原曲から探す」体験を成立させる。

#### #5 公式作品一覧

* カテゴリ別（PC-98/Windows/ZUN’s…）に閲覧できる

#### #6 公式作品詳細

* 作品情報（名称、発売日等）
* 収録公式曲一覧（登場文脈があれば併記）

#### #7 公式曲一覧

* 一覧/検索/絞り込み（最低限のカテゴリ/作品起点）

#### #8 公式曲詳細（P-21）

* 公式曲情報（日本語/英語名等）
* 登場作品と文脈（Stage等）
* キャラクタとの対応（ある場合）

#### #9 公式曲→アレンジ一覧（最重要）

* アレンジは **トラック一覧中心**
* 並び：頒布日降順（新しい順）
* 併用フィルタ：サークル、配信ありのみ、役割条件、派生タイプ（将来でも可）

#### #10–#11 関連ナビ（作品↔曲の行き来）

* 作品→曲、曲→作品への往復導線

---

### #12–#16 サークル（P3系）

**目的**：「サークルの新譜を追う」体験を成立させる。

#### #12 サークル一覧

* 頭文字索引で辿れる（latin/かな/漢字/記号など）

#### #13 サークル検索

* 名称検索（表記揺れ前提）

#### #14 サークル詳細（P3）

* サークル基本情報
* 外部リンク（公式サイト、BOOTH、X、YouTube等）
* **リリース中心**
* **曲一覧タブを標準提供**

#### #15 サークル詳細：リリース一覧

* 頒布日降順
* リリース種別で絞り込み（将来でも可）

#### #16 サークル詳細：曲一覧タブ

* リリース跨ぎでトラック一覧
* 検索結果列はP-11に近い形（少なくとも曲名/リリース/頒布日/配信）

---

### #17–#21 イベント（P4系）

**目的**：「イベントから新譜を追う」体験を成立させる。

#### #17 イベントシリーズ一覧

* 例：コミックマーケット、例大祭等

#### #18 イベント回一覧

* 回次、開催日、会場等の一覧

#### #19 イベント回詳細（P4）

* **リリース一覧が中心**
* （将来/同時）曲一覧タブを閲覧可能

#### #20 イベント回詳細：曲一覧タブ

* イベント回に紐づくリリースのトラックを俯瞰表示

#### #21 イベント検索

* 回次/年/月/会場などで絞れる（最低限は回次・年で可）

---

### #22–#26 リリース（P5系）

**目的**：「新譜」「配信先」「収録曲」を最短で見せる。

#### #22 リリース一覧

* 新着（頒布日降順）
* 種別フィルタ（album/single/video…）は将来でも可

#### #23 リリース検索

* 名称、カタ番で検索

#### #24 リリース詳細（P5）

* リリース情報（名称、頒布日、イベント回、カタ番、種別）
* 関与サークル（役割・順序）

#### #25 リリース詳細：収録曲

* discがあれば disc→track順
* discが無ければ track順

#### #26 リリース詳細：配信リンク（上部集約）

* 代表リンクを目立たせる
* 国、公開状態、公開日時等は表示可能（初期はURLとプラットフォーム名でも可）

---

### #27–#33 トラック（P6系）

**目的**：曲の最終詳細。原曲・クレジット・配信を統合して見せる。

#### #27 トラック一覧

* 全体一覧（最初は必須でなくても可、検索が主）

#### #28 トラック検索

* #2/#3で満たす（独立ページはP-11）

#### #29 トラック詳細（P-61）

ブロック順は「2.7」に準拠。

#### #30 トラック配信リンク

* track_publications を表示
* 無ければ release_publications に誘導

#### #31 トラック原曲対応

* 複数原曲対応
* 順序（part_position）
* 任意：区間秒、確度、備考

#### #32 トラック派生（別版）

* relationship_type + notes で管理された関連トラックを表示
* UIの最終形は未確定（ただし表示できることは要件）

#### #33 トラッククレジット

* 盤面表記（credit_name）を第一に表示
* 人物（artist）/別名義（artist_alias）へリンク
* 役割（vocal/arrange/lyric等）を役割別に表示
* 順序（credit_position/role_position）を尊重

---

### #34–#37 アーティスト/役割（P7系）

**目的**：「歌っている人」「編曲者」から辿る導線を成立させる。

#### #34 アーティスト一覧

* 索引・検索で辿れる

#### #35 アーティスト詳細

* 参加トラック一覧（役割横断）
* 別名義一覧（ローマ字/別名義）

#### #36 役割一覧

* 役割（vocalist/arranger/lyricist…）を入口にする

#### #37 役割→アーティスト→トラック一覧

* **役割 → アーティスト一覧 → トラック一覧** の導線

---

### #42–#44 統計

**目的**：運用の可視化、閲覧の発見性向上。
**現行仕様**

* #42 統計ダッシュボード（登録数など）
* #43 ランキング（原曲別/役割者別等）
* #44 最近更新（最近追加/最近更新）

> 具体的なランキング指標・集計定義は未確定（決定事項に回す）

---

## 5. Admin（管理）機能要件（51, 52, 58–82）

### #51 管理ログイン

* Publicとは別のログイン導線
* 管理者/編集者を分けたい（RBACは未確定事項にて後述）

### #52 管理ダッシュボード

* 最低限：最近編集、最近追加、警告（未入力の必須情報など）
* 将来：申請（編集権限）未処理件数など

---

### #58–#78 入力（CRUD）対象

以下は全て **作成/編集/削除（論理削除）/復元**の運用を想定。

#### #58 公式作品 CRUD

* カテゴリ、名称、発売日、備考等

#### #59 公式曲 CRUD

* 元曲/公式アレンジの関係
* 登場作品/文脈
* キャラクタ対応（将来でも可）

#### #60 サークル CRUD

#### #61 サークル外部リンク CRUD

* platforms に紐づくURL
* 公式/代表フラグ等

#### #62 イベントシリーズ CRUD

#### #63 イベント回 CRUD

#### #64 イベント日 CRUD

* 日別（1日目/2日目等）管理（最初は最小実装でも可）

#### #65 リリース CRUD

* 頒布日、イベント回、カタ番、種別、備考

#### #66 ディスク CRUD（任意）

* DISC1等

#### #67 リリース関与サークル CRUD

* role、position

#### #68 トラック CRUD

* disc任意、番号、名称

#### #69 トラッククレジット CRUD

* credit_name（盤面表記）
* artist、artist_alias の対応
* 順序

#### #70 クレジット役割付与 CRUD

* 1クレジットに複数役割付与（role_position）

#### #71 トラック↔公式曲対応 CRUD

* 複数原曲、順序
* 任意：区間秒、確度

#### #72 トラック派生 CRUD

* relationship_type（採用方針：追加推奨度高）
* 親子、notes

#### #73 リリース配信リンク CRUD

#### #74 トラック配信リンク CRUD

* platform、URL、公式/非公式、公開状態、国、代表リンク等

#### #75 JANコード CRUD（任意）

#### #76 ISRC CRUD（任意）

#### #77 テンポ/解析メタ CRUD（任意）

#### #78 マスタ CRUD

* platforms / credit_roles / alias_types / 公式カテゴリ等

---

### #79–#82 履歴・削除

**要求（確定）**：「履歴管理したい」

#### #79 監査ログ記録

* create/update/delete/restore を記録
* 誰が、いつ、何を、どの程度変更したか

#### #80 監査ログ閲覧

* レコード別に履歴を追える

#### #81 論理削除（削除/復元）

* Publicからは基本的に非表示
* Adminでは復元可能

#### #82 削除済み表示（管理画面のみ）

* 削除済み一覧、復元導線

---

## 6. 権限・編集フロー（要求として存在、ただし詳細未確定）

### 6.1 RBAC（必須要件）

* Admin / Editor のロールを用意したい
* 一般ユーザーとは別のログイン画面にしたい

### 6.2 サークル限定編集権限

* 特定ユーザーに対し「特定サークルのみ編集可」を付与したい

### 6.3 編集申請フロー

* 編集者が「このサークルを編集したい」と申請し、管理者が承認/却下できるようにしたい

> ただし、RBACの「機能単位の可否表」は未確定（決定事項に回す）

---

## 7. 検索（将来Meilisearch等導入を見据えた要求）

### 7.1 現行フェーズの検索実装方針（要求）

* 初期はDB検索でもよいが、検索仕様は将来エンジンに移しても意味が変わらないこと
* AND/OR/NOT、field:value を維持する
* 曖昧検索あり・詳細検索もあり（ただし具体仕様は未確定）

### 7.2 検索対象（最低限含めるべきフィールド）

* track.name（日本語/英語）
* release.name
* circle.name
* credit_name（盤面表記）
* artist.name / artist_alias.name
* official_song.name
* event.name

---

## 8. 非機能要件（最低限）

### 8.1 可用性・保守性

* データが増えても検索一覧（P-11）が破綻しない（1行=1トラック）
* 監査ログ/論理削除により、誤編集・誤削除から復旧できる

### 8.2 性能

* P-11（詳細検索）は体感で遅くならないこと（具体SLOは未確定だが、将来検索エンジン導入で解決可能な設計にする）
* Public詳細（トラック/リリース/サークル/原曲）はキャッシュやクエリ最適化が可能な構造

### 8.3 SEO/共有（推奨）

* PublicページはURLが安定している（共有しやすい）
* タイトル/メタ情報が最低限出る（将来）

---

# 9. 次フェーズで「決めないといけないこと」（未決定事項一覧）

ここは最後に明確に列挙します。これが埋まると設計が確定します。

## 9.1 権限（最優先で確定が必要）

1. **RBAC権限表（Admin/Editor）を機能単位で確定**

   * 例：公式曲編集可否、リリース削除可否、監査ログ閲覧可否、復元可否など
2. **サークル限定編集の権限モデル**（割当単位、継承、期限の有無）
3. **編集申請フロー**（申請項目、承認手順、通知、取り消し）

## 9.2 派生 relationship_type（高優先）

4. **relationship_type の列挙値**（再録/リマスター/動画版/別ミックス/…）
5. **トラック詳細での派生表示UI**（リスト/グルーピング/親子の見せ方）

## 9.3 検索仕様（次に重要）

6. **曖昧検索の定義**（表記揺れ、同義語、かなカナ、英字大小、記号など）
7. **全文検索の範囲**（notesを含めるか、どのフィールドまで対象か）
8. **クエリ言語の文法の確定**（括弧、フレーズ、エスケープ、NOTの別記法など）

## 9.4 統計/ランキング

9. **ランキング指標の定義**（原曲別：何で順位付け？登録数/被参照数/最近増加？）
10. **最近更新の定義**（更新対象の範囲：どのテーブルの更新を拾うか）

## 9.5 将来拡張

11. **閲覧者ログインでやる機能の範囲**（お気に入り：対象はトラック/リリース/原曲/サークル？ 通知は？）
12. **画像・メディア資産の扱い**（保持場所、権利表記、サイズ、表示箇所）

---

必要なら、次の出力として「この完全版をそのまま実装に落とすための補助資料」を作れます。具体的には **(1) 画面遷移図、(2) P-11検索結果DTO（JSON）、(3) Admin各CRUDのフォーム項目（必須/任意/バリデーション）**です。これを作ると、DB設計が「迷いなく」固まります。
